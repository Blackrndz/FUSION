 /* ****************************************************************************
 * $Revision: 48884 $:
 * $Author: dhara.pithadiya $:
 * $Date: 2015-08-18 14:24:02 +0700 (Tue, 18 Aug 2015) $:
 * $HeadURL: http://svn01.rapidesuite.com:999/svn/a/dev/rapidesuite/controldata/FUSION_11.1.9/trunk/core/reverse_sql/FINANCIALS/Manage%20Transaction%20Types%20-%20Manage%20Transaction%20Types.sql $:
 * $Id: Manage Transaction Types - Manage Transaction Types.sql 48884 2015-08-18 07:24:02Z dhara.pithadiya $:
 * ****************************************************************************
 * Description:
 * ************************************************************************** */


-- RSC_PREREQUISITE_OBJECTS=ASE_APP_ROLE_VL
-- NO_REMOVE_COMMENTS


WITH DATASEC AS (SELECT BBB.ACTION_ID
	,BBB.ROLE_CODE
	,BBB.POLICY_NAME
	,BBB.START_DATE
	,BBB.DB_RESOURCE
	,BBB.MENU_ID
	,BBB.POLICY_TYPE
	,BBB.DS_VALUE1
	,BBB.DS_VALUE2
	,BBB.DS_VALUE3
	,BBB.DS_VALUE4
	,BBB.DS_VALUE5
	,BBB.DS_VALUE6
	,BBB.DS_VALUE7
	,BBB.DS_VALUE_SET
	FROM (SELECT ActionsE0.ACTION_ID
	,ActionsE0.ATTRIBUTE_VALUE_TEXT ROLE_CODE
	,POLICY_NAME.ATTR_VALUE POLICY_NAME
	,START_DATE.ATTR_VALUE START_DATE
	,MENU_ID.ATTR_VALUE MENU_ID
	,DB_RESOURCE.ATTR_VALUE DB_RESOURCE
	,POLICY_TYPE.ATTR_VALUE POLICY_TYPE
	,DS_VALUE1.ATTR_VALUE DS_VALUE1
	,DS_VALUE2.ATTR_VALUE DS_VALUE2
	,DS_VALUE3.ATTR_VALUE DS_VALUE3
	,DS_VALUE4.ATTR_VALUE DS_VALUE4
	,DS_VALUE5.ATTR_VALUE DS_VALUE5
	,DS_VALUE6.ATTR_VALUE DS_VALUE6
	,DS_VALUE7.ATTR_VALUE DS_VALUE7
	,DS_VALUE_SET.ATTR_VALUE DS_VALUE_SET
	FROM ASE_STAGED_ACTION_VALUE ActionsE0
	,(SELECT ActionsE1.ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'DISPLAY_NAME'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) POLICY_NAME
	,(SELECT TO_CHAR(ActionsE1.ATTRIBUTE_VALUE_TIMESTAMP,'DD-Mon-YYYY') ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'START_DATE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.sql.Timestamp'
		) START_DATE
	,(SELECT ATTRIBUTE_VALUE_NUMBER ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'MENU_ID'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.Long'
		) MENU_ID
	,(SELECT ATTRIBUTE_VALUE_NUMBER ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'OBJECT_ID'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.Long'
		) DB_RESOURCE
	,(SELECT ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'POLICY_TYPE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) POLICY_TYPE
	,(SELECT ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'INSTANCE_PK_1_VALUE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) DS_VALUE1
	,(SELECT ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'INSTANCE_PK_2_VALUE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) DS_VALUE2
	,(SELECT ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'INSTANCE_PK_3_VALUE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) DS_VALUE3
	,(SELECT ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'INSTANCE_PK_4_VALUE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) DS_VALUE4
	,(SELECT ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'INSTANCE_PK_5_VALUE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) DS_VALUE5
	,(SELECT ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'INSTANCE_PK_6_VALUE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) DS_VALUE6
	,(SELECT ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'INSTANCE_PK_7_VALUE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) DS_VALUE7
	,(SELECT ATTRIBUTE_VALUE_NUMBER ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'INSTANCE_SET_ID'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.Long'
		) DS_VALUE_SET
	WHERE ActionsE0.ACTION_ID NOT IN (SELECT ACTION_ID FROM ASE_STAGED_ACTION WHERE ACTION_TYPE = 'DATA_SECURITY_POLICY' AND ACTION_NAME LIKE 'D%')
	AND ActionsE0.ATTRIBUTE_NAME = 'ROLE_NAME'
	AND ActionsE0.ATTRIBUTE_TYPE = 'java.lang.String'
	AND ActionsE0.ACTION_ID = POLICY_NAME.ACTION_ID
	AND ActionsE0.ACTION_ID = DB_RESOURCE.ACTION_ID
	AND ActionsE0.ACTION_ID = START_DATE.ACTION_ID
	AND ActionsE0.ACTION_ID = MENU_ID.ACTION_ID(+)
	AND ActionsE0.ACTION_ID = POLICY_TYPE.ACTION_ID
	AND ActionsE0.ACTION_ID = DS_VALUE1.ACTION_ID(+)
	AND ActionsE0.ACTION_ID = DS_VALUE2.ACTION_ID(+)
	AND ActionsE0.ACTION_ID = DS_VALUE3.ACTION_ID(+)
	AND ActionsE0.ACTION_ID = DS_VALUE4.ACTION_ID(+)
	AND ActionsE0.ACTION_ID = DS_VALUE5.ACTION_ID(+)
	AND ActionsE0.ACTION_ID = DS_VALUE6.ACTION_ID(+)
	AND ActionsE0.ACTION_ID = DS_VALUE7.ACTION_ID(+)
	AND ActionsE0.ACTION_ID = DS_VALUE_SET.ACTION_ID(+)
	) BBB
	WHERE POLICY_NAME IS NOT NULL
	)
	
SELECT DISTINCT RES_ROLE_NAME
,RES_ROLE_CODE
,RES_POLICY_NAME
,RES_DATABASE_RESOURCE
,RES_START_DATE
,RES_PRIMARY_KEY_VALUE1
,RES_PRIMARY_KEY_VALUE2
,RES_PRIMARY_KEY_VALUE3
,RES_PRIMARY_KEY_VALUE4
,RES_PRIMARY_KEY_VALUE5
,RES_PRIMARY_KEY_VALUE6
,RES_PRIMARY_KEY_VALUE7
,RES_ACTIONS_NAME
,DECODE(menuE0.FUNCTION_ID,NULL,'No','Yes') RES_ACTIONS_VALUE
,RSC_LAST_UPDATED_BY
,RSC_LAST_UPDATE_DATE
,RSC_CREATED_BY
,RSC_CREATION_DATE
,null RSC_LEDGER_ID
,null RSC_CHART_OF_ACCOUNTS_ID
,null RSC_BUSINESS_UNIT_ID
,null RSC_LEGAL_ENTITY_ID
,null RSC_ORGANIZATION_ID
,null RSC_BUSINESS_GROUP_ID
,NULL RSC_ENTERPRISE_ID
,NULL RSC_COUNTRY_ID

FROM (SELECT DutyRolesE0.ROLE_NAME RES_ROLE_NAME
	,DutyRolesE0.CODE RES_ROLE_CODE
	,DATASEC1.POLICY_NAME RES_POLICY_NAME
	,(SELECT DISPLAY_NAME 
		FROM FND_OBJECTS_TL
		WHERE OBJECT_ID = DATASEC1.DB_RESOURCE
		AND LANGUAGE = USERENV('LANG')
		) RES_DATABASE_RESOURCE
	,DATASEC1.START_DATE RES_START_DATE
	,(CASE
		WHEN DATASEC1.POLICY_TYPE = 'INSTANCE' THEN
			DATASEC1.DS_VALUE1
		WHEN DATASEC1.POLICY_TYPE = 'SET' THEN
			(SELECT DISPLAY_NAME
				FROM FND_OBJECT_INSTANCE_SETS_TL
				WHERE INSTANCE_SET_ID = DATASEC1.DS_VALUE_SET
				AND LANGUAGE = USERENV('LANG'))
		END) RES_PRIMARY_KEY_VALUE1
	,DECODE(DATASEC1.DS_VALUE2,'*NULL*',NULL,DATASEC1.DS_VALUE2) RES_PRIMARY_KEY_VALUE2
	,DECODE(DATASEC1.DS_VALUE3,'*NULL*',NULL,DATASEC1.DS_VALUE3) RES_PRIMARY_KEY_VALUE3
	,DECODE(DATASEC1.DS_VALUE4,'*NULL*',NULL,DATASEC1.DS_VALUE4) RES_PRIMARY_KEY_VALUE4
	,DECODE(DATASEC1.DS_VALUE5,'*NULL*',NULL,DATASEC1.DS_VALUE5) RES_PRIMARY_KEY_VALUE5
	,DECODE(DATASEC1.DS_VALUE6,'*NULL*',NULL,DATASEC1.DS_VALUE6) RES_PRIMARY_KEY_VALUE6
	,DECODE(DATASEC1.DS_VALUE7,'*NULL*',NULL,DATASEC1.DS_VALUE7) RES_PRIMARY_KEY_VALUE7
	,FunctionsE0.USER_FUNCTION_NAME RES_ACTIONS_NAME
	/*,(CASE 
		WHEN EXISTS (SELECT FUNCTION_ID FROM FND_MENU_ENTRIES WHERE FUNCTION_ID = FunctionsE0.FUNCTION_ID AND MENU_ID IN (SELECT MENU_ID FROM DATASEC WHERE DATASEC.R1 = 1 AND ROLE_CODE = DutyRolesE0.CODE))
			OR FunctionsE0.FUNCTION_ID IN (SELECT ATTRIBUTE_VALUE_NUMBER FROM ASE_STAGED_ACTION_VALUE AC WHERE AC.ACTION_ID IN (SELECT ACTION_ID FROM DATASEC WHERE DATASEC.R1 = 1 AND ROLE_CODE = DutyRolesE0.CODE) AND AC.ATTRIBUTE_NAME IS NULL)
			THEN
			'Yes'
		ELSE
			'No'
		END) RES_ACTIONS_VALUE*/
	,DutyRolesE0.LAST_UPDATED_BY  RSC_LAST_UPDATED_BY
	,DutyRolesE0.LAST_UPDATE_DATE  RSC_LAST_UPDATE_DATE
	,DutyRolesE0.CREATED_BY  RSC_CREATED_BY
	,DutyRolesE0.CREATION_DATE  RSC_CREATION_DATE
	,DATASEC1.ACTION_ID
	,FunctionsE0.FUNCTION_ID
	,null RSC_LEDGER_ID
	,null RSC_CHART_OF_ACCOUNTS_ID
	,null RSC_BUSINESS_UNIT_ID
	,null RSC_LEGAL_ENTITY_ID
	,null RSC_ORGANIZATION_ID
	,null RSC_BUSINESS_GROUP_ID
	,NULL RSC_ENTERPRISE_ID
,NULL RSC_COUNTRY_ID

	FROM ASE_ROLE_VL DutyRolesE0
	,(SELECT DISTINCT POLICY_NAME
		,ROLE_CODE
		,DB_RESOURCE
		,START_DATE
		,ACTION_ID
		,POLICY_TYPE
		,DS_VALUE1
		,DS_VALUE2
		,DS_VALUE3
		,DS_VALUE4
		,DS_VALUE5
		,DS_VALUE6
		,DS_VALUE7
		,DS_VALUE_SET
		FROM DATASEC
		) DATASEC1
	,FND_FORM_FUNCTIONS_VL FunctionsE0
	WHERE DutyRolesE0.CODE = DATASEC1.ROLE_CODE
	AND FunctionsE0.OBJECT_ID = DATASEC1.DB_RESOURCE
	AND SYSDATE BETWEEN DutyRolesE0.EFFECTIVE_START_DATE AND NVL(DutyRolesE0.EFFECTIVE_END_DATE,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) mainE0

,(SELECT ACTION_ID
	,FUNCTION_ID 
	FROM DATASEC
	,FND_MENU_ENTRIES menuEntriesE0
	WHERE DATASEC.MENU_ID = menuEntriesE0.MENU_ID
	UNION
	SELECT ACTION_ID 
	,ATTRIBUTE_VALUE_NUMBER FUNCTION_ID
	FROM ASE_STAGED_ACTION_VALUE 
	WHERE ATTRIBUTE_NAME IS NULL
	) menuE0
WHERE mainE0.ACTION_ID = menuE0.ACTION_ID(+)
AND mainE0.FUNCTION_ID = menuE0.FUNCTION_ID(+)

ORDER BY 1,3,4,6,7,8,9,10,11,12