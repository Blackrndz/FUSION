/* ****************************************************************************
 * $Revision: 80527 $:
 * $Author: pisan.jariyasettachok $:
 * $Date: 2023-03-22 18:01:28 +0700 (Wed, 22 Mar 2023) $:
 * $HeadURL: https://svn03.rapid4cloud.com/svn/a/dev/rapidesuite/controldata/FUSION_11.1.13/trunk/core/reverse_sql/FINANCIALS/Manage%20Asset%20Books%20-%20Manage%20Asset%20Books.sql $:
 * $Id: Manage Asset Books - Manage Asset Books.sql 80527 2023-03-22 11:01:28Z pisan.jariyasettachok $:
 * ****************************************************************************
 * Description:
 * ************************************************************************** */
 
-- RSC_PREREQUISITE_OBJECTS=FA_BOOK_CONTROLS

SELECT QRSLT.BOOK_TYPE_CODE   RES_NAME       
,QRSLT.BOOK_TYPE_NAME RES_DESCRIPTION
,DECODE(QRSLT.BOOK_CLASS,'CORPORATE','Corporate','TAX','Tax') RES_BOOK_CLASS
,QRSLT.DISTRIBUTION_SOURCE_BOOK RES_ASSOCIATED_CORPORATE_BOOK
,(CASE
	WHEN bookCtrlMcE0.BOOK_TYPE_CODE IS NOT NULL THEN 
		(CASE 
			WHEN (SELECT LEDGER_CATEGORY_CODE FROM GL_LEDGERS WHERE LEDGER_ID = bookCtrlMcE0.SET_OF_BOOKS_ID AND ROWNUM = 1) = 'ALC' THEN
				(SELECT NAME
					FROM GL_LEDGERS
					WHERE LEDGER_ID = bookCtrlMcE0.PRIMARY_SET_OF_BOOKS_ID
					AND ROWNUM = 1)
			ELSE
				(SELECT NAME
					FROM GL_LEDGERS
					WHERE LEDGER_ID = bookCtrlMcE0.SET_OF_BOOKS_ID
					AND ROWNUM = 1)
			END)
	ELSE
		QRSLT.NAME 
	END) RES_LEDGER
,QRSLT.DEPRN_CALENDAR RES_DEPRECIATION_CALENDAR
,QRSLT.FISCAL_YEAR_NAME RES_FISCAL_YEAR_NAME
,QRSLT.PRORATE_CALENDAR RES_PRORATE_CALENDAR
,QRSLT.PERIOD_NAME RES_CURRENT_PERIOD
,QRSLT.CURRENT_FISCAL_YEAR RES_CURRENT_FISCAL_YEAR
,DECODE(QRSLT.DEPRN_ALLOCATION_CODE,'E','Evenly','D','By days') RES_DIVIDE_DEPRECIATION
,TO_CHAR(QRSLT.LAST_DEPRN_RUN_DATE,'DD-Mon-YYYY HH24:MI:SS') RES_LAST_DEPRECIATION_RUN
,(SELECT LOOKUPPEO.MEANING 
	FROM FND_LOOKUPS LOOKUPPEO 
	WHERE LOOKUPPEO.LOOKUP_TYPE = 'FA_DEPRN_STATUS' 
	AND LOOKUPPEO.LOOKUP_CODE = QRSLT.DEPRN_STATUS
	) RES_LAST_DEPRECIATION_RUN_STAT
,DECODE(QRSLT.DEPR_FIRST_YEAR_RET_FLAG,'YES','Yes','No') RES_DEPRECIATE_IF_RETIRED_IN_T		 
,DECODE(QRSLT.AMORTIZE_FLAG,'YES','Yes','No') RES_ALLOW_AMORTIZED_CHANGES		  
,DECODE(QRSLT.ALLOW_COST_SIGN_CHANGE_FLAG,'Y','Yes','No') RES_ALLOW_COST_SIGN_CHANGES
,DECODE(QRSLT.ALLOW_IMPAIRMENT_FLAG,'Y','Yes','No') RES_ALLOW_IMPAIRMENT
,DECODE(QRSLT.GL_POSTING_ALLOWED_FLAG,'YES','Yes','No') RES_ALLOW_LEDGER_POSTING
,NULL RES_ALLOW_DEPRECIATION_OVERRID
,DECODE(QRSLT.ALLOW_PHYSICAL_INVENTORY_FLAG,'Y','Yes','No') RES_ALLOW_PHYSICAL_INVENTORY
,DECODE(QRSLT.ALLOW_LEASES_FLAG,'Y','Yes','No') RES_ALLOW_LEASED_ASSETS
,(CASE
	WHEN QRSLT.BOOK_CLASS = 'CORPORATE' THEN 
		DECODE(QRSLT.DEFAULT_DPIS_TO_INV_DATE_FLAG,'Y','Yes','No') 
	END) RES_USE_PAYABLES_INVOICE_DATE_
,(CASE
	WHEN QRSLT.BOOK_CLASS = 'CORPORATE' THEN 
		DECODE(QRSLT.ALLOW_UNALLOCATED_LINES_FLAG,'Y','Yes','No')
	END) RES_ALLOW_UNALLOCATED_PAYABLES
,(CASE
	WHEN QRSLT.BOOK_CLASS = 'CORPORATE' THEN 
		DECODE(QRSLT.SUPPRESS_INV_AUTO_MERGE_FLAG,'Y','Yes','No')
	END) RES_SUSPEND_AUTOMATIC_MERGE_OF
,DECODE(QRSLT.USE_NBV_THRESHOLD_FLAG,'Y','Yes','No') RES_USE_NBV_THRESHOLD_FOR_DEPR
,ROUND((QRSLT.CAPITAL_GAIN_THRESHOLD/12),2) RES_CAPITAL_GAIN_THRESHOLD_YEA
,MOD(QRSLT.CAPITAL_GAIN_THRESHOLD,12) RES_MONTHS
,TO_CHAR(QRSLT.DATE_INEFFECTIVE,'DD-Mon-YYYY') RES_INACTIVE_ON
,(SELECT LOOKUPPEO.MEANING 
	FROM FND_LOOKUPS LOOKUPPEO 
	WHERE LOOKUPPEO.LOOKUP_TYPE = 'FA_ANN_ROUND' 
	AND LOOKUPPEO.LOOKUP_CODE = QRSLT.ROUND_ANNUAL_DEPRECIATION
	) RES_ANNUAL_DEPRECIATION_ROUNDI
,FND_FLEX_EXT.GET_SEGS(APPLICATION_SHORT_NAME => 'GL'
	,KEY_FLEX_CODE => 'GL#'
	,STRUCTURE_NUMBER => QRSLT.ACCOUNTING_FLEX_STRUCTURE
	,COMBINATION_ID => QRSLT.FLEXBUILDER_DEFAULTS_CCID
	) RES_ACCOUNT_DEFAULTS
,QRSLT.NBV_RETIRED_GAIN_ACCT RES_NET_BOOK_VALUE_RETIRED_GAI
,QRSLT.NBV_RETIRED_LOSS_ACCT RES_NET_BOOK_VALUE_RETIRED_LOS
,QRSLT.PROCEEDS_OF_SALE_GAIN_ACCT  RES_PROCEEDS_OF_SALE_GAIN
,QRSLT.PROCEEDS_OF_SALE_LOSS_ACCT  RES_PROCEEDS_OF_SALE_LOSS
,QRSLT.PROCEEDS_OF_SALE_CLEARING_ACCT RES_PROCEEDS_OF_SALE_CLEARING
,QRSLT.COST_OF_REMOVAL_GAIN_ACCT  RES_COST_OF_REMOVAL_GAIN
,QRSLT.COST_OF_REMOVAL_LOSS_ACCT  RES_COST_OF_REMOVAL_LOSS
,QRSLT.COST_OF_REMOVAL_CLEARING_ACCT RES_COST_OF_REMOVAL_CLEARING
,QRSLT.DEFERRED_DEPRN_EXPENSE_ACCT RES_DEFERRED_DEPRECIATION_EXPE
,QRSLT.DEFERRED_DEPRN_RESERVE_ACCT RES_DEFERRED_DEPRECIATION_RESE
,QRSLT.REVAL_RSV_RETIRED_GAIN_ACCT RES_REVALUATION_RESERVE_RETIRE
,QRSLT.REVAL_RSV_RETIRED_LOSS_ACCT RES_REVALUATION_RESERVE_RETI_0
,QRSLT.NON_SALE_GAIN_ACCT RES_NON_SALE_GAIN
,QRSLT.LAST_UPDATED_BY  AS RSC_LAST_UPDATED_BY
,QRSLT.LAST_UPDATE_DATE AS RSC_LAST_UPDATE_DATE
,QRSLT.CREATED_BY  AS RSC_CREATED_BY
,QRSLT.CREATION_DATE AS RSC_CREATION_DATE
,PGL.PRIMARY_LEDGER_ID AS RSC_LEDGER_ID
,null RSC_CHART_OF_ACCOUNTS_ID
,null RSC_BUSINESS_UNIT_ID
,null RSC_LEGAL_ENTITY_ID
,null RSC_ORGANIZATION_ID
,null RSC_BUSINESS_GROUP_ID
,NULL RSC_ENTERPRISE_ID
,NULL RSC_COUNTRY_ID
FROM (SELECT BookControlEO.BOOK_CONTROL_ID
	,BookControlEO.BOOK_TYPE_CODE
	,BookControlEO.BOOK_TYPE_NAME
	,BookControlEO.DISTRIBUTION_SOURCE_BOOK
	,BookControlEO.BOOK_CLASS
	,BookControlEO.SET_OF_BOOKS_ID
	,BookControlEO.DEPRN_CALENDAR
	,BookControlEO.FISCAL_YEAR_NAME
	,BookControlEO.PRORATE_CALENDAR
	,BookControlEO.CURRENT_FISCAL_YEAR
	,BookControlEO.DEPR_FIRST_YEAR_RET_FLAG
	,BookControlEO.AMORTIZE_FLAG
	,BookControlEO.ALLOW_MASS_CHANGES
	,BookControlEO.ALLOW_COST_SIGN_CHANGE_FLAG
	,BookControlEO.GL_POSTING_ALLOWED_FLAG
	,BookControlEO.DEPRN_ALLOCATION_CODE
	,BookControlEO.DATE_INEFFECTIVE
	,BookControlEO.LAST_DEPRN_RUN_DATE
	,BookControlEO.FLEXBUILDER_DEFAULTS_CCID
	,BookControlEO.ACCOUNTING_FLEX_STRUCTURE
	,BookControlEO.DEFERRED_DEPRN_EXPENSE_ACCT
	,BookControlEO.DEFERRED_DEPRN_RESERVE_ACCT
	,BookControlEO.PROCEEDS_OF_SALE_GAIN_ACCT
	,BookControlEO.COST_OF_REMOVAL_GAIN_ACCT
	,BookControlEO.NBV_RETIRED_GAIN_ACCT
	,BookControlEO.PROCEEDS_OF_SALE_LOSS_ACCT
	,BookControlEO.COST_OF_REMOVAL_LOSS_ACCT
	,BookControlEO.NBV_RETIRED_LOSS_ACCT
	,BookControlEO.PROCEEDS_OF_SALE_CLEARING_ACCT
	,BookControlEO.COST_OF_REMOVAL_CLEARING_ACCT
	,BookControlEO.ALLOW_GROUP_DEPRN_FLAG
	,BookControlEO.ALLOW_CIP_MEMBER_FLAG
	,BookControlEO.ALLOW_CIP_DEP_GROUP_FLAG
	,BookControlEO.ALLOW_MEMBER_TRACKING_FLAG
	,BookControlEO.ALLOW_INTERCO_GROUP_FLAG
	,BookControlEO.ALLOW_CIP_ASSETS_FLAG
	,BookControlEO.ALLOW_COST_CEILING
	,BookControlEO.ALLOW_DEPRN_EXP_CEILING
	,BookControlEO.ALLOW_MASS_COPY
	,BookControlEO.COPY_ADDITIONS_FLAG
	,BookControlEO.COPY_ADJUSTMENTS_FLAG
	,BookControlEO.COPY_RETIREMENTS_FLAG
	,BookControlEO.COPY_SALVAGE_VALUE_FLAG
	,BookControlEO.INITIAL_DATE
	,BookControlEO.MC_SOURCE_FLAG
	,BookControlEO.DEPRN_REQUEST_ID
	,BookControlEO.ALLOW_PURGE_FLAG
	,BookControlEO.ATTRIBUTE_CATEGORY_CODE
	,BookControlEO.CAPITAL_GAIN_THRESHOLD
	,BookControlEO.DEPRN_STATUS
	,BookControlEO.INITIAL_PERIOD_COUNTER
	,BookControlEO.LAST_MASS_COPY_PERIOD_COUNTER
	,BookControlEO.LAST_PERIOD_COUNTER
	,BookControlEO.LAST_PURGE_PERIOD_COUNTER
	,BookControlEO.MASS_COPY_SOURCE_BOOK
	,BookControlEO.MASS_REQUEST_ID
	,BookControlEO.NBV_AMOUNT_THRESHOLD
	,BookControlEO.NBV_FRACTION_THRESHOLD
	,BookControlEO.IMMEDIATE_COPY_FLAG
	,BookControlEO.USE_PERCENT_SALVAGE_VALUE_FLAG
	,BookControlEO.REVAL_YTD_DEPRN_FLAG
	,BookControlEO.ALLOW_BACKDATED_TRANSFERS_FLAG
	,BookControlEO.CREATE_ACCOUNTING_REQUEST_ID
	,BookControlEO.AMORTIZE_REVAL_RESERVE_FLAG
	,BookControlEO.DEFAULT_LIFE_EXTENSION_CEILING
	,BookControlEO.DEFAULT_LIFE_EXTENSION_FACTOR
	,BookControlEO.DEFAULT_MAX_FULLY_RSVD_REVALS
	,BookControlEO.DEFAULT_REVAL_FULLY_RSVD_FLAG
	,BookControlEO.REVAL_DEPRN_RESERVE_FLAG
	,BookControlEO.RETIRE_REVAL_RESERVE_FLAG
	,BookControlEO.COPY_GROUP_ASSIGNMENT_FLAG
	,BookControlEO.COPY_GROUP_ADDITION_FLAG
	,BookControlEO.ALLOW_REVAL_FLAG
	,BookControlEO.REVAL_RSV_RETIRED_GAIN_ACCT
	,BookControlEO.REVAL_RSV_RETIRED_LOSS_ACCT
	,BookControlEO.FULLY_RESERVED_FLAG
	,BookControlEO.OBJECT_VERSION_NUMBER
	,BookControlEO.ROUND_ANNUAL_DEPRECIATION
	,BookControlEO.USE_NBV_THRESHOLD_FLAG
	,BookControlEO.DEFAULT_DPIS_TO_INV_DATE_FLAG
	,BookControlEO.ALLOW_UNALLOCATED_LINES_FLAG
	,BookControlEO.SUPPRESS_INV_AUTO_MERGE_FLAG
	,BookControlEO.COPY_AMORT_ADAJ_EXP_FLAG
	,BookControlEO.COPY_ALL_COST_ADJUSTMENTS_FLAG
	,BookControlEO.LAST_CREATE_MASS_ADDITIONS_ID
	,BookControlEO.LAST_POST_MASS_ADDITIONS_ID
	,BookControlEO.NON_SALE_GAIN_ACCT
	,BOOKCONTROLEO.LAST_UPDATED_BY
	,BookControlEO.LAST_UPDATE_DATE
	,BOOKCONTROLEO.CREATED_BY
	,BookControlEO.CREATION_DATE
	,GlLedgers.NAME
	,GlLedgers.LEDGER_ID
	,BookControlEO.ALLOW_IMPAIRMENT_FLAG
	,BookControlEO.ALLOW_DEPRN_OVERRIDE_FLAG
	,BookControlEO.ALLOW_COST_BASED_REVAL_FLAG
	,BookControlEO.ALLOW_FUND_ACCOUNTING_FLAG
	,BookControlEO.ALLOW_NBV_BASED_REVAL_FLAG
	,BOOKCONTROLEO.DEFAULT_PERIOD_END_REVAL_FLAG
	,BOOKCONTROLEO.ALLOW_PHYSICAL_INVENTORY_FLAG
	,DepreciationPeriodEO.PERIOD_NAME
	,BOOKCONTROLEO.ALLOW_LEASES_FLAG
	FROM FA_BOOK_CONTROLS BookControlEO
	,GL_LEDGERS GLLEDGERS 
	,(SELECT PERIOD_NAME
		,BOOK_TYPE_CODE 
		FROM (SELECT PERIOD_NAME
			,BOOK_TYPE_CODE
			,ROW_NUMBER() OVER (PARTITION BY BOOK_TYPE_CODE ORDER BY PERIOD_COUNTER DESC) R1
			FROM FA_DEPRN_PERIODS)
		WHERE R1 = 1) DEPRECIATIONPERIODEO
	WHERE BOOKCONTROLEO.BOOK_TYPE_CODE = DEPRECIATIONPERIODEO.BOOK_TYPE_CODE 
	--AND BOOKCONTROLEO.INITIAL_PERIOD_COUNTER+1 =   DEPRECIATIONPERIODEO.PERIOD_COUNTER    
	and BookControlEO.SET_OF_BOOKS_ID = GlLedgers.LEDGER_ID(+) ) QRSLT
,(select RSHIP.TARGET_LEDGER_ID
	, RSHIP.PRIMARY_LEDGER_ID 
	from GL_LEDGER_RELATIONSHIPS RSHIP
	WHERE (RSHIP.RELATIONSHIP_TYPE_CODE <> 'NONE'
	AND RSHIP.TARGET_LEDGER_CATEGORY_CODE = 'SECONDARY')
	OR (RSHIP.RELATIONSHIP_TYPE_CODE = 'NONE'
	AND RSHIP.TARGET_LEDGER_CATEGORY_CODE = 'PRIMARY')) PGL
,FA_MC_BOOK_CONTROLS bookCtrlMcE0
WHERE QRSLT.SET_OF_BOOKS_ID = PGL.TARGET_LEDGER_ID
AND QRSLT.BOOK_TYPE_CODE = bookCtrlMcE0.BOOK_TYPE_CODE(+)
order by (CASE
	WHEN QRSLT.BOOK_CLASS = 'CORPORATE' THEN
		1
	ELSE
		2
	END)
,QRSLT.BOOK_TYPE_CODE