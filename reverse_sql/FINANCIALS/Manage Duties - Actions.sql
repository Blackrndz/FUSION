/* ****************************************************************************
 * $Revision: 79858 $:
 * $Author: pisan.jariyasettachok $:
 * $Date: 2022-12-21 11:54:37 +0700 (Wed, 21 Dec 2022) $:
 * $HeadURL: https://svn03.rapid4cloud.com/svn/a/dev/rapidesuite/controldata/FUSION_11.1.13/trunk/core/reverse_sql/FINANCIALS/Manage%20Duties%20-%20Actions.sql $:
 * $Id: Manage Duties - Actions.sql 79858 2022-12-21 04:54:37Z pisan.jariyasettachok $:
 * ****************************************************************************
 * Description:
 * ************************************************************************** */

-- RSC_PREREQUISITE_OBJECTS=ASE_APP_ROLE_VL

WITH DATASEC AS (SELECT BBB.ACTION_ID
	,BBB.ROLE_CODE
	--,ROW_NUMBER() OVER (PARTITION BY BBB.ROLE_CODE,BBB.POLICY_NAME,BBB.MENU_ID,BBB.DB_RESOURCE,BBB.START_DATE ORDER BY BBB.ACTION_ID DESC) SEQ
	
	,BBB.POLICY_NAME
	,BBB.START_DATE
	,BBB.DB_RESOURCE
	,BBB.MENU_ID
	,BBB.POLICY_TYPE
	,BBB.DS_VALUE1
	,BBB.DS_VALUE2
	,BBB.DS_VALUE3
	,BBB.DS_VALUE4
	,BBB.DS_VALUE5
	,BBB.DS_VALUE6
	,BBB.DS_VALUE7
	,BBB.DS_VALUE_SET
	,BBB.FUNCT_VALUES_ID
	,BBB.SEQ
	--,BBB.SEQ1
	,BBB.ACTION_NAME
	,BBB.GRANT_GUID
	FROM (SELECT ActionsE0.ACTION_ID
	,ActionsE0.ATTRIBUTE_VALUE_TEXT ROLE_CODE
	,ROW_NUMBER() OVER (PARTITION BY ActionsE0.ATTRIBUTE_VALUE_TEXT
		,POLICY_NAME.ATTR_VALUE
		,DB_RESOURCE.ATTR_VALUE
		,START_DATE.ATTR_VALUE
		--,MENU_ID.ATTR_VALUE
		--,GRANT_GUID.ATTR_VALUE
		ORDER BY ActionsE0.ACTION_ID DESC) SEQ
	--,ROW_NUMBER() OVER (PARTITION BY ActionsE0.ATTRIBUTE_VALUE_TEXT ORDER BY ActionsE0.ACTION_ID DESC)
	,POLICY_NAME.ATTR_VALUE POLICY_NAME
	,START_DATE.ATTR_VALUE START_DATE
	,MENU_ID.ATTR_VALUE MENU_ID
	,DB_RESOURCE.ATTR_VALUE DB_RESOURCE
	,POLICY_TYPE.ATTR_VALUE POLICY_TYPE
	,DS_VALUE1.ATTR_VALUE DS_VALUE1
	,DS_VALUE2.ATTR_VALUE DS_VALUE2
	,DS_VALUE3.ATTR_VALUE DS_VALUE3
	,DS_VALUE4.ATTR_VALUE DS_VALUE4
	,DS_VALUE5.ATTR_VALUE DS_VALUE5
	,DS_VALUE6.ATTR_VALUE DS_VALUE6
	,DS_VALUE7.ATTR_VALUE DS_VALUE7
	,DS_VALUE_SET.ATTR_VALUE DS_VALUE_SET
	,FUNCTION_IDS.ATTR_VALUE FUNCT_VALUES_ID
	,GRANT_GUID.ATTR_VALUE GRANT_GUID
	,(SELECT ACTION_NAME 
		FROM ASE_STAGED_ACTION 
		WHERE ACTION_TYPE = 'DATA_SECURITY_POLICY' 
		AND ACTION_ID = ActionsE0.ACTION_ID
		) ACTION_NAME
	FROM ASE_STAGED_ACTION_VALUE ActionsE0
	,(SELECT ActionsE1.ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'DISPLAY_NAME'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) POLICY_NAME
	,(SELECT TO_CHAR(ActionsE1.ATTRIBUTE_VALUE_TIMESTAMP,'DD-Mon-YYYY') ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'START_DATE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.sql.Timestamp'
		) START_DATE
	,(SELECT ATTRIBUTE_VALUE_NUMBER ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'MENU_ID'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.Long'
		) MENU_ID
	,(SELECT ATTRIBUTE_VALUE_NUMBER ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'OBJECT_ID'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.Long'
		) DB_RESOURCE
	,(SELECT ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'POLICY_TYPE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) POLICY_TYPE
	,(SELECT ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'INSTANCE_PK_1_VALUE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) DS_VALUE1
	,(SELECT ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'INSTANCE_PK_2_VALUE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) DS_VALUE2
	,(SELECT ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'INSTANCE_PK_3_VALUE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) DS_VALUE3
	,(SELECT ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'INSTANCE_PK_4_VALUE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) DS_VALUE4
	,(SELECT ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'INSTANCE_PK_5_VALUE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) DS_VALUE5
	,(SELECT ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'INSTANCE_PK_6_VALUE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) DS_VALUE6
	,(SELECT ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'INSTANCE_PK_7_VALUE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) DS_VALUE7
	,(SELECT ATTRIBUTE_VALUE_NUMBER ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'INSTANCE_SET_ID'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.Long'
		) DS_VALUE_SET
	,(SELECT ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'GRANT_GUID'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) GRANT_GUID
	,(SELECT ActionsE1.VALUE_ID ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'FUNCTION_IDS'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.util.HashSet'
		) FUNCTION_IDS
	WHERE /*ActionsE0.ACTION_ID NOT IN (SELECT ACTION_ID FROM ASE_STAGED_ACTION WHERE ACTION_TYPE = 'DATA_SECURITY_POLICY' AND ACTION_NAME LIKE 'D%')
	AND*/ ActionsE0.ATTRIBUTE_NAME = 'ROLE_NAME'
	AND ActionsE0.ATTRIBUTE_TYPE = 'java.lang.String'
	AND ActionsE0.ACTION_ID = POLICY_NAME.ACTION_ID
	AND ActionsE0.ACTION_ID = DB_RESOURCE.ACTION_ID
	AND ActionsE0.ACTION_ID = START_DATE.ACTION_ID
	AND ActionsE0.ACTION_ID = MENU_ID.ACTION_ID(+)
	AND ActionsE0.ACTION_ID = POLICY_TYPE.ACTION_ID
	AND ActionsE0.ACTION_ID = DS_VALUE1.ACTION_ID(+)
	AND ActionsE0.ACTION_ID = DS_VALUE2.ACTION_ID(+)
	AND ActionsE0.ACTION_ID = DS_VALUE3.ACTION_ID(+)
	AND ActionsE0.ACTION_ID = DS_VALUE4.ACTION_ID(+)
	AND ActionsE0.ACTION_ID = DS_VALUE5.ACTION_ID(+)
	AND ActionsE0.ACTION_ID = DS_VALUE6.ACTION_ID(+)
	AND ActionsE0.ACTION_ID = DS_VALUE7.ACTION_ID(+)
	AND ActionsE0.ACTION_ID = DS_VALUE_SET.ACTION_ID(+)
	AND ActionsE0.ACTION_ID = FUNCTION_IDS.ACTION_ID(+)
	AND ActionsE0.ACTION_ID = GRANT_GUID.ACTION_ID(+)
	) BBB
	WHERE POLICY_NAME IS NOT NULL
	--AND SEQ = 1
	)
,MENU AS (SELECT PARENT_VALUE_ID VALUE_ID
	,ATTRIBUTE_VALUE_NUMBER FUNCTION_ID
	FROM ASE_STAGED_ACTION_VALUE
	WHERE PARENT_VALUE_ID IS NOT NULL)
,ACTION AS (
	SELECT DATASEC.ACTION_ID
	,DATASEC.ROLE_CODE
	,DATASEC.POLICY_NAME
	,DATASEC.START_DATE
	,DATASEC.DB_RESOURCE
	,ACTION_CHECK.ATTR_VALUE ACTION_CHECK
	FROM DATASEC
	,(SELECT ActionsE1.ATTRIBUTE_VALUE_NUMBER ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME IS NULL
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.Long'
		) ACTION_CHECK
	WHERE DATASEC.ACTION_ID = ACTION_CHECK.ACTION_ID(+)
	/*SELECT ActionsE0.ACTION_ID
	,ActionsE0.ATTRIBUTE_VALUE_TEXT ROLE_CODE
	,POLICY_NAME.ATTR_VALUE POLICY_NAME
	,START_DATE.ATTR_VALUE START_DATE
	,DB_RESOURCE.ATTR_VALUE DB_RESOURCE
	,ACTION_CHECK.ATTR_VALUE ACTION_CHECK
	FROM ASE_STAGED_ACTION_VALUE ActionsE0
	,(SELECT ActionsE1.ATTRIBUTE_VALUE_TEXT ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'DISPLAY_NAME'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.String'
		) POLICY_NAME
	,(SELECT TO_CHAR(ActionsE1.ATTRIBUTE_VALUE_TIMESTAMP,'DD-Mon-YYYY') ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'START_DATE'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.sql.Timestamp'
		) START_DATE
	,(SELECT ATTRIBUTE_VALUE_NUMBER ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME = 'OBJECT_ID'
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.Long'
		) DB_RESOURCE
	,(SELECT ActionsE1.ATTRIBUTE_VALUE_NUMBER ATTR_VALUE
		,ActionsE1.ACTION_ID
		FROM ASE_STAGED_ACTION_VALUE ActionsE1
		WHERE ActionsE1.ATTRIBUTE_NAME IS NULL
		AND ActionsE1.ATTRIBUTE_TYPE = 'java.lang.Long'
		) ACTION_CHECK
	WHERE ActionsE0.ATTRIBUTE_NAME = 'ROLE_NAME'
	AND ActionsE0.ATTRIBUTE_TYPE = 'java.lang.String'
	AND ActionsE0.ACTION_ID = POLICY_NAME.ACTION_ID
	AND ActionsE0.ACTION_ID = DB_RESOURCE.ACTION_ID
	AND ActionsE0.ACTION_ID = START_DATE.ACTION_ID
	AND ActionsE0.ACTION_ID = ACTION_CHECK.ACTION_ID(+)*/
	)


SELECT DutyRolesE0.ROLE_NAME RES_ROLE_NAME
--,ACTION_ID
,DutyRolesE0.CODE RES_ROLE_CODE
,DATASEC1.POLICY_NAME RES_POLICY_NAME
,(SELECT DISPLAY_NAME 
	FROM FND_OBJECTS_TL
	WHERE OBJECT_ID = DATASEC1.DB_RESOURCE
	AND LANGUAGE = USERENV('LANG')
	) RES_DATABASE_RESOURCE
,DATASEC1.START_DATE RES_START_DATE
,(CASE
	WHEN DATASEC1.POLICY_TYPE = 'INSTANCE' THEN
		'Select by key'
	WHEN DATASEC1.POLICY_TYPE = 'SET' THEN
		'Select by instance set'
	WHEN DATASEC1.POLICY_TYPE = 'GLOBAL' THEN
		'All values'
	END) RES_DATA_SET
,(CASE
	WHEN DATASEC1.POLICY_TYPE = 'INSTANCE' THEN
		DATASEC1.DS_VALUE1
	WHEN DATASEC1.POLICY_TYPE = 'SET' THEN
		(SELECT DISPLAY_NAME
			FROM FND_OBJECT_INSTANCE_SETS_TL
			WHERE INSTANCE_SET_ID = DATASEC1.DS_VALUE_SET
			AND LANGUAGE = USERENV('LANG'))
	END) RES_PRIMARY_KEY_VALUE1
,DECODE(DATASEC1.DS_VALUE2,'*NULL*',NULL,DATASEC1.DS_VALUE2) RES_PRIMARY_KEY_VALUE2
,DECODE(DATASEC1.DS_VALUE3,'*NULL*',NULL,DATASEC1.DS_VALUE3) RES_PRIMARY_KEY_VALUE3
,DECODE(DATASEC1.DS_VALUE4,'*NULL*',NULL,DATASEC1.DS_VALUE4) RES_PRIMARY_KEY_VALUE4
,DECODE(DATASEC1.DS_VALUE5,'*NULL*',NULL,DATASEC1.DS_VALUE5) RES_PRIMARY_KEY_VALUE5
,DECODE(DATASEC1.DS_VALUE6,'*NULL*',NULL,DATASEC1.DS_VALUE6) RES_PRIMARY_KEY_VALUE6
,DECODE(DATASEC1.DS_VALUE7,'*NULL*',NULL,DATASEC1.DS_VALUE7) RES_PRIMARY_KEY_VALUE7
,(SELECT USER_FUNCTION_NAME
	FROM FND_FORM_FUNCTIONS_VL
	WHERE FUNCTION_ID = ACTION1.ACTION_CHECK
	) RES_ACTIONS_NAME
,'Yes' RES_ACTIONS_VALUE
/*,(CASE
	WHEN EXISTS (SELECT 1 FROM ACTION WHERE ACTION_ID = DATASEC1.ACTION_ID AND ACTION_CHECK = ACTION1.ACTION_CHECK) THEN
		'Yes'
	ELSE
		'No'
	END) RES_ACTIONS_VALUE*/
,DutyRolesE0.LAST_UPDATED_BY  RSC_LAST_UPDATED_BY
,DutyRolesE0.LAST_UPDATE_DATE  RSC_LAST_UPDATE_DATE
,DutyRolesE0.CREATED_BY  RSC_CREATED_BY
,DutyRolesE0.CREATION_DATE  RSC_CREATION_DATE
,null RSC_LEDGER_ID
,null RSC_CHART_OF_ACCOUNTS_ID
,null RSC_BUSINESS_UNIT_ID
,null RSC_LEGAL_ENTITY_ID
,null RSC_ORGANIZATION_ID
,null RSC_BUSINESS_GROUP_ID
,NULL RSC_ENTERPRISE_ID
,NULL RSC_COUNTRY_ID
FROM ASE_ROLE_VL DutyRolesE0
,DATASEC DATASEC1
,(SELECT ACTION_ID
	,ROLE_CODE
	,POLICY_NAME
	,START_DATE
	,DB_RESOURCE
	,ACTION_CHECK
	FROM ACTION
	WHERE ACTION_CHECK IS NOT NULL
	) ACTION1
WHERE 1 = 1
AND DutyRolesE0.CODE = DATASEC1.ROLE_CODE
AND SYSDATE BETWEEN DutyRolesE0.EFFECTIVE_START_DATE AND NVL(DutyRolesE0.EFFECTIVE_END_DATE,TO_DATE('31-12-4712','DD-MM-YYYY'))
AND DATASEC1.SEQ = 1
AND GRANT_GUID IS NOT NULL
AND DATASEC1.ACTION_NAME NOT LIKE 'D%'

AND DATASEC1.ACTION_ID = ACTION1.ACTION_ID
AND DATASEC1.ROLE_CODE = ACTION1.ROLE_CODE
AND DATASEC1.POLICY_NAME = ACTION1.POLICY_NAME
AND DATASEC1.START_DATE = ACTION1.START_DATE
AND DATASEC1.DB_RESOURCE = ACTION1.DB_RESOURCE

UNION

SELECT DutyRolesE0.ROLE_NAME RES_ROLE_NAME
--,ACTION_ID
,DutyRolesE0.CODE RES_ROLE_CODE
,DATASEC1.POLICY_NAME RES_POLICY_NAME
,(SELECT DISPLAY_NAME 
	FROM FND_OBJECTS_TL
	WHERE OBJECT_ID = DATASEC1.DB_RESOURCE
	AND LANGUAGE = USERENV('LANG')
	) RES_DATABASE_RESOURCE
,DATASEC1.START_DATE RES_START_DATE
,(CASE
	WHEN DATASEC1.POLICY_TYPE = 'INSTANCE' THEN
		'Select by key'
	WHEN DATASEC1.POLICY_TYPE = 'SET' THEN
		'Select by instance set'
	WHEN DATASEC1.POLICY_TYPE = 'GLOBAL' THEN
		'All values'
	END) RES_DATA_SET
,(CASE
	WHEN DATASEC1.POLICY_TYPE = 'INSTANCE' THEN
		DATASEC1.DS_VALUE1
	WHEN DATASEC1.POLICY_TYPE = 'SET' THEN
		(SELECT DISPLAY_NAME
			FROM FND_OBJECT_INSTANCE_SETS_TL
			WHERE INSTANCE_SET_ID = DATASEC1.DS_VALUE_SET
			AND LANGUAGE = USERENV('LANG'))
	END) RES_PRIMARY_KEY_VALUE1
,DECODE(DATASEC1.DS_VALUE2,'*NULL*',NULL,DATASEC1.DS_VALUE2) RES_PRIMARY_KEY_VALUE2
,DECODE(DATASEC1.DS_VALUE3,'*NULL*',NULL,DATASEC1.DS_VALUE3) RES_PRIMARY_KEY_VALUE3
,DECODE(DATASEC1.DS_VALUE4,'*NULL*',NULL,DATASEC1.DS_VALUE4) RES_PRIMARY_KEY_VALUE4
,DECODE(DATASEC1.DS_VALUE5,'*NULL*',NULL,DATASEC1.DS_VALUE5) RES_PRIMARY_KEY_VALUE5
,DECODE(DATASEC1.DS_VALUE6,'*NULL*',NULL,DATASEC1.DS_VALUE6) RES_PRIMARY_KEY_VALUE6
,DECODE(DATASEC1.DS_VALUE7,'*NULL*',NULL,DATASEC1.DS_VALUE7) RES_PRIMARY_KEY_VALUE7
,(SELECT USER_FUNCTION_NAME
	FROM FND_FORM_FUNCTIONS_VL
	WHERE FUNCTION_ID = ACTION1.ACTION_CHECK
	) RES_ACTIONS_NAME
,'No' RES_ACTIONS_VALUE
/*,(CASE
	WHEN EXISTS (SELECT 1 FROM ACTION WHERE ACTION_ID = DATASEC1.ACTION_ID AND ACTION_CHECK = ACTION1.ACTION_CHECK) THEN
		'Yes'
	ELSE
		'No'
	END) RES_ACTIONS_VALUE*/
,DutyRolesE0.LAST_UPDATED_BY  RSC_LAST_UPDATED_BY
,DutyRolesE0.LAST_UPDATE_DATE  RSC_LAST_UPDATE_DATE
,DutyRolesE0.CREATED_BY  RSC_CREATED_BY
,DutyRolesE0.CREATION_DATE  RSC_CREATION_DATE
,null RSC_LEDGER_ID
,null RSC_CHART_OF_ACCOUNTS_ID
,null RSC_BUSINESS_UNIT_ID
,null RSC_LEGAL_ENTITY_ID
,null RSC_ORGANIZATION_ID
,null RSC_BUSINESS_GROUP_ID
,NULL RSC_ENTERPRISE_ID
,NULL RSC_COUNTRY_ID
FROM ASE_ROLE_VL DutyRolesE0
,DATASEC DATASEC1
,(SELECT DISTINCT ROLE_CODE
	,POLICY_NAME
	,START_DATE
	,DB_RESOURCE
	,ACTION_CHECK
	FROM ACTION
	WHERE ACTION_CHECK IS NOT NULL
	) ACTION1
WHERE 1 = 1
AND DutyRolesE0.CODE = DATASEC1.ROLE_CODE
AND SYSDATE BETWEEN DutyRolesE0.EFFECTIVE_START_DATE AND NVL(DutyRolesE0.EFFECTIVE_END_DATE,TO_DATE('31-12-4712','DD-MM-YYYY'))
AND DATASEC1.SEQ = 1
AND GRANT_GUID IS NOT NULL
AND DATASEC1.ACTION_NAME NOT LIKE 'D%'

--AND DATASEC1.ACTION_ID = ACTION1.ACTION_ID
AND DATASEC1.ROLE_CODE = ACTION1.ROLE_CODE
AND DATASEC1.POLICY_NAME = ACTION1.POLICY_NAME
AND DATASEC1.START_DATE = ACTION1.START_DATE
AND DATASEC1.DB_RESOURCE = ACTION1.DB_RESOURCE

AND NOT EXISTS (SELECT 1 FROM ACTION WHERE ACTION_ID = DATASEC1.ACTION_ID AND ACTION_CHECK = ACTION1.ACTION_CHECK)

UNION

/*Due to the data have default setting when user have create the first record on the history.*/
SELECT DutyRolesE0.ROLE_NAME RES_ROLE_NAME
--,ACTION_ID
,DutyRolesE0.CODE RES_ROLE_CODE
,DATASEC1.POLICY_NAME RES_POLICY_NAME
,(SELECT DISPLAY_NAME 
	FROM FND_OBJECTS_TL
	WHERE OBJECT_ID = DATASEC1.DB_RESOURCE
	AND LANGUAGE = USERENV('LANG')
	) RES_DATABASE_RESOURCE
,DATASEC1.START_DATE RES_START_DATE
,(CASE
	WHEN DATASEC1.POLICY_TYPE = 'INSTANCE' THEN
		'Select by key'
	WHEN DATASEC1.POLICY_TYPE = 'SET' THEN
		'Select by instance set'
	WHEN DATASEC1.POLICY_TYPE = 'GLOBAL' THEN
		'All values'
	END) RES_DATA_SET
,(CASE
	WHEN DATASEC1.POLICY_TYPE = 'INSTANCE' THEN
		DATASEC1.DS_VALUE1
	WHEN DATASEC1.POLICY_TYPE = 'SET' THEN
		(SELECT DISPLAY_NAME
			FROM FND_OBJECT_INSTANCE_SETS_TL
			WHERE INSTANCE_SET_ID = DATASEC1.DS_VALUE_SET
			AND LANGUAGE = USERENV('LANG'))
	END) RES_PRIMARY_KEY_VALUE1
,DECODE(DATASEC1.DS_VALUE2,'*NULL*',NULL,DATASEC1.DS_VALUE2) RES_PRIMARY_KEY_VALUE2
,DECODE(DATASEC1.DS_VALUE3,'*NULL*',NULL,DATASEC1.DS_VALUE3) RES_PRIMARY_KEY_VALUE3
,DECODE(DATASEC1.DS_VALUE4,'*NULL*',NULL,DATASEC1.DS_VALUE4) RES_PRIMARY_KEY_VALUE4
,DECODE(DATASEC1.DS_VALUE5,'*NULL*',NULL,DATASEC1.DS_VALUE5) RES_PRIMARY_KEY_VALUE5
,DECODE(DATASEC1.DS_VALUE6,'*NULL*',NULL,DATASEC1.DS_VALUE6) RES_PRIMARY_KEY_VALUE6
,DECODE(DATASEC1.DS_VALUE7,'*NULL*',NULL,DATASEC1.DS_VALUE7) RES_PRIMARY_KEY_VALUE7
/*,(SELECT USER_FUNCTION_NAME
	FROM FND_MENUS_VL menu
	,FND_MENU_ENTRIES menuEnt
	,FND_FORM_FUNCTIONS_VL func
	WHERE menu.MENU_ID = menuEnt.MENU_ID
	AND menuEnt.FUNCTION_ID = func.FUNCTION_ID
	AND menu.MENU_ID = DATASEC1.MENU_ID
	AND func.OBJECT_ID = DATASEC1.DB_RESOURCE
	AND ROWNUM = 1
	) RES_ACTIONS_NAME*/
,USER_FUNCTION_NAME RES_ACTIONS_NAME
,'Yes' RES_ACTIONS_VALUE
,DutyRolesE0.LAST_UPDATED_BY  RSC_LAST_UPDATED_BY
,DutyRolesE0.LAST_UPDATE_DATE  RSC_LAST_UPDATE_DATE
,DutyRolesE0.CREATED_BY  RSC_CREATED_BY
,DutyRolesE0.CREATION_DATE  RSC_CREATION_DATE
,null RSC_LEDGER_ID
,null RSC_CHART_OF_ACCOUNTS_ID
,null RSC_BUSINESS_UNIT_ID
,null RSC_LEGAL_ENTITY_ID
,null RSC_ORGANIZATION_ID
,null RSC_BUSINESS_GROUP_ID
,NULL RSC_ENTERPRISE_ID
,NULL RSC_COUNTRY_ID


--,'DEFAULT'
FROM ASE_ROLE_VL DutyRolesE0
,DATASEC DATASEC1
,(SELECT USER_FUNCTION_NAME
	,menu.MENU_ID
	,func.OBJECT_ID
	FROM FND_MENUS_VL menu
	,FND_MENU_ENTRIES menuEnt
	,FND_FORM_FUNCTIONS_VL func
	WHERE menu.MENU_ID = menuEnt.MENU_ID
	AND menuEnt.FUNCTION_ID = func.FUNCTION_ID
	/*AND menu.MENU_ID = DATASEC1.MENU_ID
	AND func.OBJECT_ID = DATASEC1.DB_RESOURCE*/
	--AND ROWNUM = 1
	) ACTION
WHERE 1 = 1
AND DutyRolesE0.CODE = DATASEC1.ROLE_CODE
AND SYSDATE BETWEEN DutyRolesE0.EFFECTIVE_START_DATE AND NVL(DutyRolesE0.EFFECTIVE_END_DATE,TO_DATE('31-12-4712','DD-MM-YYYY'))
AND DATASEC1.SEQ = 1
AND GRANT_GUID IS NULL
AND DATASEC1.ACTION_NAME NOT LIKE 'D%'
AND NOT EXISTS (SELECT 1 FROM MENU WHERE VALUE_ID = FUNCT_VALUES_ID)


AND DATASEC1.MENU_ID = ACTION.MENU_ID
AND DATASEC1.DB_RESOURCE = ACTION.OBJECT_ID 


ORDER BY 1,3,4,6,7,8,9,10,11,12