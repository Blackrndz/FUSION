/* ****************************************************************************
 * $Revision:  $:
 * $Author: Nasrullah.Dusenmahamad $:
 * $Date: 2017-09-06 $:
 * $HeadURL:  $:
 * $Id: Create Implementation Users - Roles.sql  $:
 * ****************************************************************************
 * Description:
 * ************************************************************************** */


SELECT aseUserEO.USER_LOGIN RES_USER_NAME
,rolesE0.ROLE_NAME RES_ROLE_NAME
,rolesE0.CODE RES_ROLE_CODE
,'No' RES_ASSIGNABLE
,userRolesE0.LAST_UPDATED_BY RSC_LAST_UPDATED_BY
,userRolesE0.LAST_UPDATE_DATE RSC_LAST_UPDATE_DATE
,userRolesE0.CREATED_BY RSC_CREATED_BY
,userRolesE0.CREATION_DATE RSC_CREATION_DATE
,NULL RSC_LEDGER_ID
,NULL RSC_CHART_OF_ACCOUNTS_ID
,NULL RSC_BUSINESS_UNIT_ID
,NULL RSC_LEGAL_ENTITY_ID
,NULL RSC_ORGANIZATION_ID
,NULL RSC_BUSINESS_GROUP_ID
,NULL RSC_ENTERPRISE_ID
,NULL RSC_COUNTRY_ID

FROM (SELECT *
	FROM ASE_USER_B X
	,(SELECT A.GUID
		,A.ACTION_ID
		FROM (SELECT ACTION_ID 
			, GUID  
			FROM (SELECT ACTION_ID 
				, ATTRIBUTE_VALUE_TEXT AS GUID 
				FROM  (SELECT A.*
					,ROW_NUMBER() OVER(PARTITION BY A.ATTRIBUTE_VALUE_TEXT ORDER BY A.ACTION_ID DESC) R1 
					FROM ASE_STAGED_ACTION_VALUE A
					,ASE_STAGED_ACTION X
					WHERE A.ACTION_ID = X.ACTION_ID
					AND X.ACTION_TYPE = 'USER' 
					AND A.ATTRIBUTE_NAME = 'USER_LOGIN' 
					AND A.ACTION_ID NOT IN (SELECT ACTION_ID 
						FROM ASE_STAGED_ACTION 
						WHERE ACTION_TYPE = 'USER' 
						AND ACTION_NAME LIKE 'D%')) 
				WHERE R1 = 1 ) 
			WHERE ACTION_ID IN (SELECT ACTION_ID 
				FROM ASE_STAGED_ACTION_VALUE 
				WHERE ATTRIBUTE_NAME = 'USER_LOGIN')
			) A 
		) HeadEO 
	WHERE SYSDATE BETWEEN X.EFFECTIVE_START_DATE AND NVL(X.EFFECTIVE_END_DATE,TO_DATE('31-12-4712','DD-MM-YYYY'))
	AND X.USER_LOGIN = HeadEO.GUID 
	) aseUserEO
,(SELECT *
	FROM ASE_USER_ROLE_MBR 
	WHERE SYSDATE BETWEEN EFFECTIVE_START_DATE AND NVL(EFFECTIVE_END_DATE,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) userRolesE0
,(SELECT *
	FROM ASE_ROLE_VL
	WHERE SYSDATE BETWEEN EFFECTIVE_START_DATE AND NVL(EFFECTIVE_END_DATE,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) rolesE0
WHERE aseUserEO.USER_ID = userRolesE0.USER_ID
AND userRolesE0.ROLE_ID = rolesE0.ROLE_ID
ORDER BY aseUserEO.USER_LOGIN
,rolesE0.ROLE_NAME