/* ****************************************************************************
 * $Revision: 73970 $:
 * $Author: pisan.jariyasettachok $:
 * $Date: 2020-04-15 21:09:13 +0700 (Wed, 15 Apr 2020) $:
 * $HeadURL: http://svn01.rapidesuite.com:999/svn/a/dev/rapidesuite/controldata/FUSION_11.1.13.20/trunk/core/reverse_sql/FINANCIALS/Manage%20Positions%20-%20Position.sql $:
 * $Id: Manage Positions - Position.sql 73970 2020-04-15 14:09:13Z pisan.jariyasettachok $:
 * ****************************************************************************
 * Description:
 * ************************************************************************** */
 
-- RSC_PREREQUISITE_OBJECTS=PER_POSITION_HIERARCHY_F 
 
SELECT TO_CHAR(positionsE0.EFFECTIVE_START_DATE,'DD-Mon-YYYY') RES_EFFECTIVE_START_DATE
,(SELECT BUS.BU_NAME 
	FROM HR_ALL_POSITIONS_F_VL POS
	,FUN_ALL_BUSINESS_UNITS_V BUS
	WHERE POS.BUSINESS_UNIT_ID = BUS.BU_ID
	AND POS.POSITION_ID = positionsE0.PARENT_POSITION_ID
	AND SYSDATE BETWEEN POS.EFFECTIVE_START_DATE AND NVL(POS.EFFECTIVE_END_DATE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_PARENT_POSITION_BUSINESS_U
,(SELECT NAME 
	FROM HR_ALL_POSITIONS_F_VL 
	WHERE POSITION_ID = positionsE0.PARENT_POSITION_ID
	AND SYSDATE BETWEEN EFFECTIVE_START_DATE AND NVL(EFFECTIVE_END_DATE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_PARENT_POSITION_NAME
,(SELECT POSITION_CODE 
	FROM HR_ALL_POSITIONS_F_VL 
	WHERE POSITION_ID = positionsE0.PARENT_POSITION_ID
	AND SYSDATE BETWEEN EFFECTIVE_START_DATE AND NVL(EFFECTIVE_END_DATE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_PARENT_POSITION_CODE
,(SELECT BU_NAME
	FROM FUN_ALL_BUSINESS_UNITS_V
	WHERE BU_ID = positionsE0.BUSINESS_UNIT_ID 
	) RES_BUSINESS_UNIT
,positionsE0.NAME RES_NAME
,positionsE0.POSITION_CODE RES_CODE
,(SELECT AA.action_reason
	FROM fusion.PER_ACTION_REASONS_VL AA
	,fusion.PER_ACTION_OCCURRENCES BB
	WHERE BB.ACTION_OCCURRENCE_ID = positionsE0.ACTION_OCCURRENCE_ID
	AND AA.action_reason_id       = BB.action_reason_id
	) RES_ACTION_REASON 
,DECODE(positionsE0.ACTIVE_STATUS,'A','Active','I','Inactive') RES_STATUS
,(SELECT NAME 
	FROM HR_ALL_ORGANIZATION_UNITS_F_VL  
	WHERE ORGANIZATION_ID = positionsE0.ORGANIZATION_ID 
	AND SYSDATE BETWEEN EFFECTIVE_START_DATE AND NVL(EFFECTIVE_END_DATE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_DEPARTMENT
,(SELECT JOB_CODE 
	FROM PER_JOBS_F_VL 
	WHERE JOB_ID = positionsE0.JOB_ID
	AND SYSDATE BETWEEN EFFECTIVE_START_DATE AND NVL(EFFECTIVE_END_DATE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_JOB_CODE
,(SELECT NAME 
	FROM PER_JOBS_F_VL 
	WHERE JOB_ID = positionsE0.JOB_ID
	AND SYSDATE BETWEEN EFFECTIVE_START_DATE AND NVL(EFFECTIVE_END_DATE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_JOB_NAME
,(SELECT LOCATION_NAME  
	FROM HR_LOCATIONS_ALL_F_VL  
	WHERE LOCATION_ID  = positionsE0.LOCATION_ID
	AND SYSDATE BETWEEN EFFECTIVE_START_DATE AND NVL(EFFECTIVE_END_DATE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	)  RES_LOCATION
,(SELECT FULL_NAME 
	FROM PER_PERSON_NAMES_F_V 
	WHERE PERSON_ID = positionsE0.SUPERVISOR_ID 
	AND SYSDATE BETWEEN EFFECTIVE_START_DATE AND NVL(EFFECTIVE_END_DATE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_MANAGER
,(SELECT MEANING 
	FROM FND_LOOKUP_VALUES WHERE LOOKUP_CODE = positionsE0.ASSIGNMENT_CATEGORY
	AND LOOKUP_TYPE = 'EMP_CAT' 
	AND LANGUAGE = USERENV('LANG')
	AND SYSDATE BETWEEN START_DATE_ACTIVE AND NVL(END_DATE_ACTIVE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_ASSIGNMENT_CATEGORY
,(SELECT MEANING 
	FROM FND_LOOKUP_VALUES 
	WHERE LOOKUP_CODE = positionsE0.FULL_PART_TIME
	AND LOOKUP_TYPE = 'PART_FULL_TIME' 
	AND LANGUAGE = USERENV('LANG')
	AND SYSDATE BETWEEN START_DATE_ACTIVE AND NVL(END_DATE_ACTIVE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_FULL_TIME_OR_PART_TIME
,(SELECT MEANING 
	FROM FND_LOOKUP_VALUES 
	WHERE LOOKUP_CODE = positionsE0.PERMANENT_TEMPORARY_FLAG
	AND LOOKUP_TYPE = 'REGULAR_TEMPORARY' 
	AND LANGUAGE = USERENV('LANG')
	AND SYSDATE BETWEEN START_DATE_ACTIVE AND NVL(END_DATE_ACTIVE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_REGULAR_OR_TEMPORARY


-- Hiring Information

,(SELECT MEANING 
	FROM FND_LOOKUP_VALUES 
	WHERE LOOKUP_CODE = positionsE0.HIRING_STATUS
	AND LOOKUP_TYPE = 'HIRING_STATUS' 
	AND LANGUAGE = USERENV('LANG')
	) RES_HIRING_STATUS
,(SELECT MEANING 
	FROM FND_LOOKUP_VALUES 
	WHERE LOOKUP_CODE = positionsE0.POSITION_TYPE 
	AND LOOKUP_TYPE = 'POSITION_TYPE' 
	AND LANGUAGE = USERENV('LANG')
	) RES_TYPE
,positionsE0.FTE RES_FTE
,positionsE0.MAX_PERSONS RES_HEAD_COUNT
,(SELECT MEANING 
	FROM FND_LOOKUP_VALUES 
	WHERE LOOKUP_CODE = positionsE0.SECURITY_CLEARANCE 
	AND LOOKUP_TYPE = 'SECURITY_CLEARANCE' 
	AND LANGUAGE = USERENV('LANG')
	) RES_SECURITY_CLEARANCE
,positionsE0.PROBATION_PERIOD RES_PROBATION_PERIOD
,(SELECT MEANING 
	FROM FND_LOOKUP_VALUES 
	WHERE LOOKUP_CODE = positionsE0.PROBATION_PERIOD_UNIT_CD 
	AND LOOKUP_TYPE = 'PROBATION_PERIOD' 
	AND LANGUAGE = USERENV('LANG')
	) RES_PROBATION_PERIOD_UOM
,(SELECT NAME 
	FROM HR_ORGANIZATION_UNITS 
	WHERE ORGANIZATION_ID =  positionsE0.UNION_ID
	AND SYSDATE BETWEEN DATE_FROM AND NVL(DATE_TO,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_UNION
,(SELECT MEANING 
	FROM FND_LOOKUP_VALUES 
	WHERE LOOKUP_CODE = positionsE0.BARGAINING_UNIT_CD 
	AND LOOKUP_TYPE = 'BARGAINING_UNIT_CODE' 
	AND LANGUAGE = USERENV('LANG')
	) RES_BARGAINING_UNIT
,(SELECT COLLECTIVE_AGREEMENT_NAME  
	FROM PER_COL_AGREEMENTS_F_VL 
	WHERE COLLECTIVE_AGREEMENT_ID  =  positionsE0.COLLECTIVE_AGREEMENT_ID 
	AND SYSDATE BETWEEN EFFECTIVE_START_DATE  AND NVL(EFFECTIVE_END_DATE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_COLLECTIVE_AGREEMENT
,positionsE0.REQUISITION_TEMPLATE_ID RES_REQUISITION_TEMPLATE
,positionsE0.DELEGATE_POSITION_ID RES_DELEGATE_POSITION
,DECODE(positionsE0.OVERLAP_ALLOWED,'Y','Yes','No') RES_OVERLAP_ALLOWED
,DECODE(positionsE0.SEASONAL_FLAG,'Y','Yes','No') RES_SEASONAL
,positionsE0.SEASONAL_START_DATE RES_SEASONAL_START_DATE
,positionsE0.SEASONAL_END_DATE RES_SEASONAL_END_DATE


-- Budget Details

,positionsE0.BUDGET_AMOUNT RES_BUDGET_AMOUNT
,positionsE0.BUDGET_AMOUNT_CURRENCY RES_CURRENCY
,DECODE(positionsE0.BUDGETED_POSITION_FLAG,'Y','Yes','N','No') RES_BUDGETED_POSITION
,positionsE0.COST_CENTER RES_COST_CENTER
,DECODE(positionsE0.FUNDED_BY_EXISTING_POSITION,'Y','Yes','No') RES_FUNDED_FROM_EXISTING_POSIT


-- Work Terms

,(SELECT NAME 
	FROM PER_GRADE_LADDERS_F_VL 
	WHERE GRADE_LADDER_ID = positionsE0.GRADE_LADDER_ID 
	AND SYSDATE BETWEEN EFFECTIVE_START_DATE AND NVL(EFFECTIVE_END_DATE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_GRADE_LADDER
,(SELECT NAME 
	FROM PER_GRADES_F_VL 
	WHERE GRADE_ID = positionsE0.ENTRY_GRADE_ID  
	AND SYSDATE BETWEEN EFFECTIVE_START_DATE AND NVL(EFFECTIVE_END_DATE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_ENTRY_GRADE
,(SELECT NAME 
	FROM PER_GRADE_STEPS_F_VL 
	WHERE GRADE_STEP_ID  =  positionsE0.ENTRY_STEP_ID 
	AND SYSDATE BETWEEN EFFECTIVE_START_DATE AND NVL(EFFECTIVE_END_DATE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_ENTRY_STEP
,positionsE0.STANDARD_WORKING_HOURS RES_STANDARD_WORKING_HOURS
,(SELECT MEANING 
	FROM FND_LOOKUP_VALUES 
	WHERE LOOKUP_CODE = positionsE0.STANDARD_WORKING_FREQUENCY
	AND LOOKUP_TYPE = 'FREQUENCY' 
	AND LANGUAGE = USERENV('LANG')
	AND SYSDATE BETWEEN START_DATE_ACTIVE AND NVL(END_DATE_ACTIVE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_FREQUENCY
,positionsE0.WORKING_HOURS RES_WORKING_HOURS
,(SELECT MEANING 
	FROM FND_LOOKUP_VALUES 
	WHERE LOOKUP_CODE = positionsE0.FREQUENCY
	AND LOOKUP_TYPE = 'FREQUENCY' 
	AND LANGUAGE = USERENV('LANG')
	AND SYSDATE BETWEEN START_DATE_ACTIVE AND NVL(END_DATE_ACTIVE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_WORKING_HOURS_FREQUENCY
,positionsE0.TIME_NORMAL_START RES_START_TIME
,positionsE0.TIME_NORMAL_FINISH RES_END_TIME


-- Brazil Position Details

,NULL RES_CBO_OCCUPATION


-- Evaluation Criteria

,(SELECT MEANING 
	FROM FND_LOOKUP_VALUES 
	WHERE LOOKUP_CODE = positionsE0.EVALUATION_SYSTEM
	AND LOOKUP_TYPE = 'EVAL_SYSTEM' 
	AND LANGUAGE = USERENV('LANG')
	AND SYSDATE BETWEEN START_DATE_ACTIVE AND NVL(END_DATE_ACTIVE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_EVALUATION_SYSTEM
,TO_CHAR(positionsE0.DATE_EVALUATED,'DD-Mon-YYYY') RES_EVALUATION_DATE
,(SELECT MEANING 
	FROM FND_LOOKUP_VALUES 
	WHERE LOOKUP_CODE = positionsE0.MEASURED_IN
	AND LOOKUP_TYPE = 'EVAL_SYSTEM_MEAS' 
	AND LANGUAGE = USERENV('LANG')
	AND SYSDATE BETWEEN START_DATE_ACTIVE AND NVL(END_DATE_ACTIVE ,TO_DATE('31-12-4712','DD-MM-YYYY'))
	) RES_MEASUREMENT_UNIT
	
,(CASE
	WHEN positionsE0.EVALUATION_SYSTEM = 'HAY' THEN
		positionsE0.KNOWHOW 
	END) RES_KNOW_HOW
,(CASE
	WHEN positionsE0.EVALUATION_SYSTEM = 'HAY' THEN
		positionsE0.ACCOUNTABILITY
	END) RES_ACCOUNTABILITY
,(CASE
	WHEN positionsE0.EVALUATION_SYSTEM = 'HAY' THEN
		positionsE0.PROBLEM_SOLVING
	END) RES_PROBLEM_SOLVING


,positionsE0.LAST_UPDATED_BY RSC_LAST_UPDATED_BY
,positionsE0.LAST_UPDATE_DATE RSC_LAST_UPDATE_DATE
,positionsE0.CREATED_BY RSC_CREATED_BY
,positionsE0.CREATION_DATE RSC_CREATION_DATE
,NULL RSC_LEDGER_ID
,NULL RSC_CHART_OF_ACCOUNTS_ID
,NULL RSC_BUSINESS_UNIT_ID
,NULL RSC_LEGAL_ENTITY_ID
,NULL RSC_ORGANIZATION_ID
,NULL RSC_BUSINESS_GROUP_ID
,NULL RSC_ENTERPRISE_ID
,NULL RSC_COUNTRY_ID

FROM (SELECT pos.*
	,posHiers.PARENT_POSITION_ID
	,posHiers.EFFECTIVE_START_DATE PARENT_START_DATE
	,posHiers.EFFECTIVE_END_DATE PARENT_END_DATE
	,jobs.EVALUATION_SYSTEM
	,jobs.DATE_EVALUATED
	,jobs.MEASURED_IN
	,jobs.KNOWHOW
	,jobs.ACCOUNTABILITY
	,jobs.PROBLEM_SOLVING
	FROM HR_ALL_POSITIONS_F_VL pos
	,PER_JOB_EVALUATIONS jobs
	,(SELECT POSITION_ID
		,PARENT_POSITION_ID
		,EFFECTIVE_START_DATE
		,EFFECTIVE_END_DATE
		FROM PER_POSITION_HIERARCHY_F 
		--WHERE SYSDATE BETWEEN EFFECTIVE_START_DATE AND EFFECTIVE_END_DATE
		) posHiers
	WHERE pos.POSITION_ID = posHiers.POSITION_ID(+)
	AND pos.POSITION_ID = jobs.POSITION_ID(+)
	AND pos.EFFECTIVE_END_DATE BETWEEN posHiers.EFFECTIVE_START_DATE(+) AND posHiers.EFFECTIVE_END_DATE(+)
	) positionsE0
/*START WITH positionsE0.PARENT_POSITION_ID IS NULL
CONNECT BY PRIOR positionsE0.POSITION_ID = positionsE0.PARENT_POSITION_ID
AND positionsE0.PARENT_START_DATE BETWEEN positionsE0.EFFECTIVE_START_DATE AND positionsE0.EFFECTIVE_END_DATE
--AND positionsE0.EFFECTIVE_START_DATE = positionsE0.PARENT_START_DATE
ORDER SIBLINGS BY positionsE0.NAME
,positionsE0.POSITION_CODE
,positionsE0.EFFECTIVE_START_DATE*/
ORDER BY DECODE(positionsE0.PARENT_POSITION_ID,NULL,1,2)
,positionsE0.NAME
,positionsE0.POSITION_CODE
,positionsE0.EFFECTIVE_START_DATE