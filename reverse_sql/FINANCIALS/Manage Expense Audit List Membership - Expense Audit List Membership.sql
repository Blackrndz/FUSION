/* ****************************************************************************
 * $Revision: 53537 $:
 * $Author: pisan.jariyasettachok $:
 * $Date: 2016-03-15 15:01:41 +0700 (Tue, 15 Mar 2016) $:
 * $HeadURL: http://svn01.rapidesuite.com:999/svn/a/dev/rapidesuite/controldata/FUSION_11.1.9/trunk/core/reverse_sql/FINANCIALS/Assign%20Legal%20Entities%20-%20Assign%20Legal%20Entities.sql $:
 * $Id: Assign Legal Entities - Assign Legal Entities.sql 53537 2016-03-15 08:01:41Z pisan.jariyasettachok $:
 * ****************************************************************************
 * Description:
 * ************************************************************************** */


SELECT PersonNameDPEO.DISPLAY_NAME RES_NAME
,PersonDPEO.PERSON_NUMBER RES_NUMBER
,BusinessUnitPEO.BU_NAME RES_BUSINESS_UNIT
,ExmLookupPEO2.DISPLAYED_FIELD RES_SOURCE
,DECODE(INSTR(AuditListMemberEO.AUDIT_LIST_REASON_CODE,'AUDITOR_ADDITION'),0,'No','Yes') RES_ADD_MEMBERSHIP_REASON_AUDI
,DECODE(INSTR(AuditListMemberEO.AUDIT_LIST_REASON_CODE,'EXCEED_MONTHLY_AMOUNT'),0,'No','Yes')
	RES_ADD_MEMBERSHIP_REASON_ALLO
,DECODE(INSTR(AuditListMemberEO.AUDIT_LIST_REASON_CODE,'EXCEED_REPORT_NUMBER'),0,'No','Yes')
	RES_ADD_MEMBERSHIP_REASON_AL_0
,DECODE(INSTR(AuditListMemberEO.AUDIT_LIST_REASON_CODE,'EXCEED_VIOLATION_NUMBER'),0,'No','Yes')
	RES_ADD_MEMBERSHIP_REASON_AL_1
,DECODE(INSTR(AuditListMemberEO.AUDIT_LIST_REASON_CODE,'LATE_RECEIPT_SUBMISSION'),0,'No','Yes')
	RES_ADD_MEMBERSHIP_REASON_LATE
,DECODE(INSTR(AuditListMemberEO.AUDIT_LIST_REASON_CODE,'LEAVE_OF_ABSENCE'),0,'No','Yes') RES_ADD_MEMBERSHIP_REASON_LEAV
,DECODE(INSTR(AuditListMemberEO.AUDIT_LIST_REASON_CODE,'TERMINATION'),0,'No','Yes') RES_ADD_MEMBERSHIP_REASON_TERM
,DECODE(INSTR(AuditListMemberEO.AUDIT_LIST_REASON_CODE,'AUD_DISPROP_CASH_EXP'),0,'No','Yes')
	RES_ADD_MEMBERSHIP_REASON_DISP
,DECODE(INSTR(AuditListMemberEO.AUDIT_LIST_REASON_CODE,'AUD_EXP_BELOW_RCT_THRESHLD'),0,'No','Yes')
	RES_ADD_MEMBERSHIP_REASON_EXPE
,DECODE(INSTR(AuditListMemberEO.AUDIT_LIST_REASON_CODE,'AUD_HIGH_FREQ_SAME_EXP'),0,'No','Yes')
	RES_ADD_MEMBERSHIP_REASON_HIGH
,DECODE(INSTR(AuditListMemberEO.AUDIT_LIST_REASON_CODE,'AUD_VIOL_UNIDENT_POLICY'),0,'No','Yes')
	RES_ADD_MEMBERSHIP_REASON_VIOL
,TO_CHAR(AuditListMemberEO.START_DATE,'DD-Mon-YYYY') RES_START_DATE
,TO_CHAR(AuditListMemberEO.END_DATE,'DD-Mon-YYYY') RES_END_DATE
,ExmLookupPEO1.DISPLAYED_FIELD RES_END_MEMBERSHIP_REASON
,AuditListMemberEO.LAST_UPDATED_BY RSC_LAST_UPDATED_BY
,AuditListMemberEO.LAST_UPDATE_DATE RSC_LAST_UPDATE_DATE
,AuditListMemberEO.CREATED_BY RSC_CREATED_BY
,AuditListMemberEO.CREATION_DATE RSC_CREATION_DATE
,NULL RSC_LEDGER_ID
,NULL RSC_CHART_OF_ACCOUNTS_ID
,BusinessUnitPEO.BU_ID RSC_BUSINESS_UNIT_ID
,NULL RSC_LEGAL_ENTITY_ID
,NULL RSC_ORGANIZATION_ID
,NULL RSC_BUSINESS_GROUP_ID
,NULL RSC_ENTERPRISE_ID
,NULL RSC_COUNTRY_ID

FROM EXM_AUD_LIST_MEMBERS AuditListMemberEO
,PER_ALL_PEOPLE_F PersonDPEO
,PER_PERSON_NAMES_F_V PersonNameDPEO
,EXM_LOOKUP_VALUES ExmLookupPEO1
,PER_ALL_ASSIGNMENTS_M AssignmentDPEO
,FUN_ALL_BUSINESS_UNITS_V BusinessUnitPEO
,EXM_LOOKUP_VALUES ExmLookupPEO2
WHERE AuditListMemberEO.PERSON_ID             = PersonDPEO.PERSON_ID(+)
AND AuditListMemberEO.PERSON_ID               = PersonNameDPEO.PERSON_ID(+)
AND AuditListMemberEO.PERSON_ID               = AssignmentDPEO.PERSON_ID(+)
AND AssignmentDPEO.PRIMARY_FLAG(+)            = 'Y'
AND AssignmentDPEO.ASSIGNMENT_TYPE(+)         = 'E'
AND AssignmentDPEO.EFFECTIVE_LATEST_CHANGE(+) = 'Y'
AND AssignmentDPEO.BUSINESS_UNIT_ID           = BusinessUnitPEO.BU_ID (+)
AND AuditListMemberEO.AUDIT_LIST_MEMBER_ID    =
	(SELECT MAX(B.AUDIT_LIST_MEMBER_ID)
	FROM EXM_AUD_LIST_MEMBERS B
	WHERE B.PERSON_ID = AuditListMemberEO.PERSON_ID
	AND B.SOURCE      = AuditListMemberEO.SOURCE
	AND B.START_DATE  = AuditListMemberEO.START_DATE
	)
AND(AuditListMemberEO.END_DATE_ADJUSTMENT_REASON = ExmLookupPEO1.LOOKUP_CODE(+)
AND ExmLookupPEO1.LOOKUP_TYPE(+)                 = 'EXM_AUD_END_DATE_ADJSTMT_RSN')
AND(AuditListMemberEO.SOURCE                     = ExmLookupPEO2.LOOKUP_CODE(+)
AND ExmLookupPEO2.LOOKUP_TYPE(+)                 = 'EXM_AUD_RECORD_SOURCE')
AND((AuditListMemberEO.END_DATE                 IS NULL)
OR(AuditListMemberEO.END_DATE                   >= SYSDATE))
AND(SYSDATE BETWEEN PersonDPEO.EFFECTIVE_START_DATE AND PersonDPEO.EFFECTIVE_END_DATE)
AND(SYSDATE BETWEEN PersonNameDPEO.EFFECTIVE_START_DATE AND PersonNameDPEO.EFFECTIVE_END_DATE)
AND(SYSDATE BETWEEN AssignmentDPEO.EFFECTIVE_START_DATE AND AssignmentDPEO.EFFECTIVE_END_DATE)
AND(AssignmentDPEO.EFFECTIVE_LATEST_CHANGE = 'Y')
ORDER BY PersonNameDPEO.LAST_NAME