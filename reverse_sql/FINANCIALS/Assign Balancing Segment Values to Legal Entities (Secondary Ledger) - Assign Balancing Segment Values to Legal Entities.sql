/* ****************************************************************************
 * $Revision: 78229 $:
 * $Author: pisan.jariyasettachok $:
 * $Date: 2022-04-07 14:37:05 +0700 (Thu, 07 Apr 2022) $:
 * $HeadURL: https://svn03.rapid4cloud.com/svn/a/dev/rapidesuite/controldata/FUSION_11.1.13/trunk/core/reverse_sql/FINANCIALS/Assign%20Balancing%20Segment%20Values%20to%20Legal%20Entities%20(Secondary%20Ledger)%20-%20Assign%20Balancing%20Segment%20Values%2 $:
 * $Id: Assign Balancing Segment Values to Legal Entities (Secondary Ledger) - Assign Balancing Segment Values to Legal Entities.sql 78229 2022-04-07 07:37:05Z pisan.jariyasettachok $:
 * ****************************************************************************
 * Description:
 * ************************************************************************** */


SELECT DISTINCT
	(SELECT GLLEDGERS.NAME
	FROM GL_LEDGERS GLLEDGERS
	WHERE GLLEDGERS.LEDGER_CATEGORY_CODE = 'PRIMARY'
	and GLLEDGERS.OBJECT_TYPE_CODE = 'L'
	AND GlLedgers.CONFIGURATION_ID       = QRSLT.CONFIGURATION_ID
	) RES_PRIMARY_LEDGER
,QRSLT.PRIMARY_LEDGER RES_SECONDARY_LEDGER
,QRSLT.VALUE_SET RES_VALUE_SET
,(SELECT NAME
	FROM XLE_ENTITY_PROFILES
	WHERE LEGAL_ENTITY_ID = QRSLT.LEGAL_ENTITY_ID) RES_LEGAL_ENTITY
,QRSLT.FLEX_SEGMENT_VALUE RES_COMPANY_VALUE
,TO_CHAR(QRSLT.START_DATE,'DD-Mon-YYYY') RES_START_DATE
,TO_CHAR(QRSLT.END_DATE,'DD-Mon-YYYY') RES_END_DATE
,QRSLT.LAST_UPDATED_BY RSC_LAST_UPDATED_BY
,QRSLT.LAST_UPDATE_DATE RSC_LAST_UPDATE_DATE
,QRSLT.CREATED_BY RSC_CREATED_BY
,QRSLT.CREATION_DATE RSC_CREATION_DATE
,PGL.PRIMARY_LEDGER_ID RSC_LEDGER_ID
,NULL RSC_CHART_OF_ACCOUNTS_ID
,NULL RSC_BUSINESS_UNIT_ID
,NULL RSC_LEGAL_ENTITY_ID
,NULL RSC_ORGANIZATION_ID
,NULL RSC_BUSINESS_GROUP_ID
,NULL RSC_ENTERPRISE_ID
,NULL RSC_COUNTRY_ID

FROM
	(SELECT GlLegalEntitiesBsvs.LEGAL_ENTITY_ID
	,GlLegalEntitiesBsvs.FLEX_VALUE_SET_ID
	,GlLegalEntitiesBsvs.FLEX_SEGMENT_VALUE
	,GlLegalEntitiesBsvs.START_DATE
	,GlLegalEntitiesBsvs.END_DATE
	,GlLegalEntitiesBsvs.CREATION_DATE
	,GlLegalEntitiesBsvs.LAST_UPDATE_DATE
	,GlLegalEntitiesBsvs.LAST_UPDATED_BY
	,GlLegalEntitiesBsvs.LAST_UPDATE_LOGIN
	,GlLegalEntitiesBsvs.CREATED_BY
	,GlLegalEntitiesBsvs.OBJECT_VERSION_NUMBER
	,ValueSetValuePEO.DESCRIPTION
	,VALUESETVALUEPEO.VALUE_ID
	,GLLEDGERCONFIGDETAILS.OBJECT_NAME
	,GLLEDGERCONFIGDETAILS.CONFIGURATION_ID
	,VALUE_SET.DESCRIPTION VALUE_SET
	,GLLEDGERS.name PRIMARY_LEDGER
	,GLLEDGERS.LEDGER_ID
	FROM FUSION.GL_LEGAL_ENTITIES_BSVS GLLEGALENTITIESBSVS
	,FUSION.FND_VS_VALUES_VL VALUESETVALUEPEO
	,FUSION.GL_LEDGER_CONFIG_DETAILS GLLEDGERCONFIGDETAILS
	,(SELECT DISTINCT(FFVS.VALUE_SET_ID)
		,FFVS.DESCRIPTION
		,GL2.CONFIGURATION_ID
		FROM FUSION.FND_KF_LABELED_SEGMENTS FKLS
		,FUSION.FND_KF_SEGMENT_INSTANCES FKSI
		,FUSION.FND_KF_STR_INSTANCES_VL FKSIV
		,FUSION.FND_VS_VALUE_SETS FFVS
		,FUSION.GL_LEDGERS GL1
		,FUSION.GL_LEDGERS GL2
		,FUSION.GL_LEDGERS GL3
		,FUSION.FND_KF_SEGMENTS_VL FKSV
		WHERE FKLS.SEGMENT_CODE             = FKSI.SEGMENT_CODE
		AND FKSI.VALUE_SET_ID               = FFVS.VALUE_SET_ID
		AND FKSIV.STRUCTURE_INSTANCE_NUMBER = GL1.CHART_OF_ACCOUNTS_ID
		AND FKSIV.STRUCTURE_INSTANCE_ID     = FKSI.STRUCTURE_INSTANCE_ID
		AND FKSIV.STRUCTURE_ID              = FKLS.STRUCTURE_ID
		AND FKSIV.KEY_FLEXFIELD_CODE        = 'GL#'
		AND FKLS.SEGMENT_LABEL_CODE         = 'GL_BALANCING'
		AND GL1.LEDGER_CATEGORY_CODE       IN('PRIMARY')
		AND GL3.LEDGER_CATEGORY_CODE(+)    IN('SECONDARY')
		AND GL1.CONFIGURATION_ID            = GL2.CONFIGURATION_ID
		AND GL1.CONFIGURATION_ID            = GL3.CONFIGURATION_ID(+)
		AND GL1.BAL_SEG_VALUE_SET_ID        = GL3.BAL_SEG_VALUE_SET_ID(+)
		AND FKLS.SEGMENT_CODE               = FKSV.SEGMENT_CODE
		AND FKLS.STRUCTURE_ID               = FKSV.STRUCTURE_ID
		UNION ALL
		SELECT *
		FROM
			(SELECT DISTINCT(FFVS.VALUE_SET_ID)
			,FFVS.DESCRIPTION
			,GL2.CONFIGURATION_ID
			FROM FUSION.FND_KF_LABELED_SEGMENTS FKLS
			,FUSION.FND_KF_SEGMENT_INSTANCES FKSI
			,FUSION.FND_KF_STR_INSTANCES_VL FKSIV
			,FUSION.FND_VS_VALUE_SETS FFVS
			,FUSION.GL_LEDGERS GL1
			,FUSION.GL_LEDGERS GL2
			,FUSION.GL_LEDGERS GL3
			,FUSION.FND_KF_SEGMENTS_VL FKSV
			WHERE FKLS.SEGMENT_CODE             = FKSI.SEGMENT_CODE
			AND FKSI.VALUE_SET_ID               = FFVS.VALUE_SET_ID
			AND FKSIV.STRUCTURE_INSTANCE_NUMBER = GL3.CHART_OF_ACCOUNTS_ID
			AND FKSIV.STRUCTURE_INSTANCE_ID     = FKSI.STRUCTURE_INSTANCE_ID
			AND FKSIV.STRUCTURE_ID              = FKLS.STRUCTURE_ID
			AND FKSIV.KEY_FLEXFIELD_CODE        = 'GL#'
			AND FKLS.SEGMENT_LABEL_CODE         = 'GL_BALANCING'
			AND GL1.LEDGER_CATEGORY_CODE       IN('PRIMARY')
			AND GL3.LEDGER_CATEGORY_CODE       IN('SECONDARY')
			AND GL1.CONFIGURATION_ID            = GL2.CONFIGURATION_ID
			AND GL1.CONFIGURATION_ID            = GL3.CONFIGURATION_ID
			AND GL1.BAL_SEG_VALUE_SET_ID       != GL3.BAL_SEG_VALUE_SET_ID
			AND FKLS.SEGMENT_CODE               = FKSV.SEGMENT_CODE
			AND FKLS.STRUCTURE_ID               = FKSV.STRUCTURE_ID
			ORDER BY FFVS.DESCRIPTION
			)
		) VALUE_SET
	,FUSION.GL_LEDGERS GLLEDGERS
	WHERE(GlLegalEntitiesBsvs.FLEX_VALUE_SET_ID = ValueSetValuePEO.VALUE_SET_ID)
	AND(GLLEGALENTITIESBSVS.FLEX_SEGMENT_VALUE  = VALUESETVALUEPEO.value)
	AND GLLEGALENTITIESBSVS.LEGAL_ENTITY_ID     = GLLEDGERCONFIGDETAILS.OBJECT_ID
	AND GLLEGALENTITIESBSVS.FLEX_VALUE_SET_ID   = VALUE_SET.VALUE_SET_ID
	AND GLLEDGERCONFIGDETAILS.CONFIGURATION_ID  = VALUE_SET.CONFIGURATION_ID
	AND VALUE_SET.CONFIGURATION_ID              = GLLEDGERS.CONFIGURATION_ID
	AND GLLEDGERS.LEDGER_CATEGORY_CODE          = 'SECONDARY'
	) QRSLT
,(select RSHIP.TARGET_LEDGER_ID, RSHIP.PRIMARY_LEDGER_ID from GL_LEDGER_RELATIONSHIPS RSHIP
	WHERE (RSHIP.RELATIONSHIP_TYPE_CODE <> 'NONE'
	AND RSHIP.TARGET_LEDGER_CATEGORY_CODE = 'SECONDARY')
	OR (RSHIP.RELATIONSHIP_TYPE_CODE = 'NONE'
	AND RSHIP.TARGET_LEDGER_CATEGORY_CODE = 'PRIMARY')) PGL
WHERE QRSLT.LEDGER_ID = PGL.TARGET_LEDGER_ID(+)
ORDER BY 1,2,3,4,5