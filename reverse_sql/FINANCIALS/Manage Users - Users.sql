/* ****************************************************************************
 * $Revision: 78517 $:
 * $Author: tanawat.wongjan $:
 * $Date: 2022-05-18 16:15:55 +0700 (Wed, 18 May 2022) $:
 * $HeadURL: https://svn03.rapid4cloud.com/svn/a/dev/rapidesuite/controldata/FUSION_11.1.13/trunk/core/reverse_sql/FINANCIALS/Manage%20Users%20-%20Users.sql $:
 * $Id: Manage Users - Users.sql 78517 2022-05-18 09:15:55Z tanawat.wongjan $:
 * ****************************************************************************
 * Description:
 * ************************************************************************** */
 

select PERSONNAMEDEO.LAST_NAME RES_LAST_NAME
,PERSONNAMEDEO.FIRST_NAME RES_FIRST_NAME
,PERSONNAMEDEO.MIDDLE_NAMES RES_MIDDLE_NAMES
,(select MEANING 
	from HCM_LOOKUPS HCMLOOKUPPEO 
	where HCMLOOKUPPEO.LOOKUP_TYPE    = 'TITLE' 
	and LOOKUP_CODE = PERSONNAMEDEO.TITLE
	) RES_TITLE
,EMAILADDRESSEO.EMAIL_ADDRESS RES_E_MAIL
,TO_CHAR(PERIODOFSERVICEEO.ORIGINAL_DATE_OF_HIRE,'DD-Mon-YYYY') RES_HIRE_DATE
,PHONEEO.PHONE_NUMBER RES_PHONE
,FAXEO.PHONE_NUMBER RES_WORK_FAX
,USERDETAILEO.MULTITENANCY_USERNAME RES_USER_NAME
,'No' RES_SEND_USER_NAME_AND_PASSWOR
,(select USER_PERSON_TYPE 
	from PER_PERSON_TYPES_VL PERSONTYPEPEO 
	where PERSONTYPEPEO.SYSTEM_PERSON_TYPE = EMP_TYPE.SYSTEM_PERSON_TYPE
	and PERSON_TYPE_ID = EMP_TYPE.PERSON_TYPE_ID 
	) RES_PERSON_TYPE
,LEGAL.name RES_LEGAL_EMPLOYER
,BUSINESSUNITPEO.BU_NAME  RES_BUSINESS_UNIT
,JOBDPEO.name RES_JOB
,GRADEDPEO.name RES_GRADE
,DEPARTMENTDPEO.name RES_DEPARTMENT
,LocationDPEO.LOCATION_NAME RES_LOCATION
,EMPLOYEEASSIGNMENTDEO.INTERNAL_MAILSTOP RES_MAIL_STOP
,(select F2.FULL_NAME 
	from PER_PERSON_NAMES_F F2 
	where F2.NAME_TYPE = 'GLOBAL' 
	and  F2.PERSON_ID = ASSIGN.MANAGER_ID
	AND SYSDATE BETWEEN F2.EFFECTIVE_START_DATE AND F2.EFFECTIVE_END_DATE
	)  RES_MANAGER_NAME
,(select DISTINCT EMAILADDRESSEO2.EMAIL_ADDRESS 
	from PER_EMAIL_ADDRESSES EMAILADDRESSEO2 
	where EMAILADDRESSEO2.PERSON_ID = ASSIGN.MANAGER_ID
	AND SYSDATE BETWEEN EMAILADDRESSEO2.DATE_FROM AND NVL(EMAILADDRESSEO2.DATE_TO,TO_DATE('31-12-4712','DD-MM-YYYY'))
	AND EMAILADDRESSEO2.MASTERED_IN_LDAP_FLAG = 'Y'
	)  RES_MANAGER_E_MAIL
,(SELECT fusion.per_person_keyword_search.replaceEscapeChar(jrt.role_name)
	FROM jtf_rs_role_relations jrr
	,jtf_rs_roles_vl jrt
	,hz_orig_sys_references osr
	WHERE jrr.role_resource_type  = 'RS_INDIVIDUAL'
	AND jrr.role_resource_id      = osr.owner_table_id
	AND osr.owner_table_name      = 'HZ_PARTIES'
	AND osr.orig_system_reference = TO_CHAR(PERSONEO.PERSON_ID)
	AND osr.orig_system           = 'FUSION_HCM'
	AND osr.status                = 'A'
	AND sysdate BETWEEN osr.start_date_active AND osr.end_date_active
	and JRR.ROLE_ID  = JRT.ROLE_ID
	and(sysdate between JRR.START_DATE_ACTIVE and JRR.END_DATE_ACTIVE)
	and JRR.DELETE_FLAG != 'Y'
	and rownum <= 1
	)  RES_RESOURCE_ROLE
,(SELECT distinct fusion.per_person_keyword_search.replaceEscapeChar(hp.party_name)
	FROM jtf_rs_rep_managers jrm
	,hz_parties hp
	,fnd_tree_version ftv
	,hz_orig_sys_references osr
	WHERE jrm.resource_id         = osr.owner_table_id
	AND osr.owner_table_name      = 'HZ_PARTIES'
	AND osr.orig_system_reference = TO_CHAR(PERSONEO.PERSON_ID)
	AND osr.orig_system           = 'FUSION_HCM'
	AND osr.status                = 'A'
	AND sysdate BETWEEN osr.start_date_active AND osr.end_date_active
	AND jrm.reports_to_flag     = 'Y'
	and JRM.PARENT_RESOURCE_ID  = HP.PARTY_ID
	AND jrm.tree_structure_code = ftv.tree_structure_code
	AND jrm.tree_version_id     = ftv.tree_version_id
	and FTV.TREE_STRUCTURE_CODE = 'RESOURCE_ORG_TREE_STRUCTURE'
	AND sysdate BETWEEN ftv.effective_start_date AND ftv.effective_end_date 
	AND sysdate BETWEEN jrm.START_DATE_ACTIVE AND jrm.END_DATE_ACTIVE
	and rownum <= 1
	) RES_REPORTING_MANAGER
,(SELECT fusion.per_person_keyword_search.replaceEscapeChar(hout.name) 
	FROM jtf_rs_group_members jrm
	,hr_organization_units_f_tl hout
	,hz_orig_sys_references osr
	WHERE jrm.group_id            = hout.organization_id
	AND jrm.resource_id           = osr.owner_table_id
	AND osr.owner_table_name      = 'HZ_PARTIES'
	AND osr.orig_system_reference = TO_CHAR(PERSONEO.PERSON_ID)
	AND osr.orig_system           = 'FUSION_HCM'
	AND osr.status                = 'A'
	and sysdate between OSR.START_DATE_ACTIVE and OSR.END_DATE_ACTIVE
	AND hout.language = 'US'
	and sysdate between HOUT.EFFECTIVE_START_DATE and HOUT.EFFECTIVE_END_DATE
	and NVL(JRM.DELETE_FLAG,'N') = 'N' 
	and rownum <=1
	) RES_ORGANIZATION
,PERSONNAMEDEO.LAST_UPDATED_BY  RSC_LAST_UPDATED_BY
,PERSONNAMEDEO.LAST_UPDATE_DATE  RSC_LAST_UPDATE_DATE
,PERSONNAMEDEO.CREATED_BY  RSC_CREATED_BY
,PERSONNAMEDEO.CREATION_DATE  RSC_CREATION_DATE
,null RSC_LEDGER_ID
,null RSC_CHART_OF_ACCOUNTS_ID
,BusinessUnitPEO.BU_ID RSC_BUSINESS_UNIT_ID
,null RSC_LEGAL_ENTITY_ID
,null RSC_ORGANIZATION_ID
,null RSC_BUSINESS_GROUP_ID
,NULL RSC_ENTERPRISE_ID
,NULL RSC_COUNTRY_ID
 
from PER_PERSONS PERSONEO
,PER_PERSON_NAMES_F PERSONNAMEDEO
,(SELECT PERSON_ID
	,LEGAL_ENTITY_ID
	,ORIGINAL_DATE_OF_HIRE
	FROM PER_PERIODS_OF_SERVICE
	WHERE SYSDATE BETWEEN DATE_START AND NVL(ACTUAL_TERMINATION_DATE,SYSDATE)
	) PERIODOFSERVICEEO
,PER_EMAIL_ADDRESSES EMAILADDRESSEO
,PER_PHONES PHONEEO
,PER_PHONES FAXEO
,PER_USERS USERDETAILEO
,PER_ALL_ASSIGNMENTS_M EMPLOYEEASSIGNMENTDEO
,PER_PERSON_TYPE_USAGES_M EMP_TYPE
,(SELECT LegalEntityPEO.LEGAL_ENTITY_ID
	,LegalEntityPEO.OBJECT_VERSION_NUMBER
	,OrganizationUnitDPEO.ORGANIZATION_ID
	,OrganizationUnitDPEO.EFFECTIVE_START_DATE
	,OrganizationUnitDPEO.EFFECTIVE_END_DATE
	,OrganizationUnitDPEO.OBJECT_VERSION_NUMBER AS OBJECT_VERSION_NUMBER1
	,LegalEntityPEO.EFFECTIVE_FROM
	,LegalEntityPEO.EFFECTIVE_TO
	,OrganizationUnitDPEO.BUSINESS_GROUP_ID
	,LegalEntityPEO.NAME
	,GeographyPEO.COUNTRY_CODE
	,GeographyPEO.GEOGRAPHY_ID
	,LegalEntityPEO.PARENT_PSU_ID
	,LegalEntityPEOParentPsu.NAME                  AS NAME1
	,LegalEntityPEOParentPsu.LEGAL_ENTITY_ID       AS LEGAL_ENTITY_ID1
	,LegalEntityPEOParentPsu.OBJECT_VERSION_NUMBER AS OBJECT_VERSION_NUMBER2
	,LegalEntityPEO.PSU_FLAG
	,JurisdictionPEO.REGISTRATION_CODE_LE
	,JurisdictionPEO.JURISDICTION_ID
	,XleLookupPEO.MEANING
	,XleLookupPEO.LOOKUP_TYPE
	,XleLookupPEO.LOOKUP_CODE
	,RegistrationPEO.REGISTRATION_NUMBER
	,RegistrationPEO.REGISTRATION_ID
	,RegistrationPEO.REGISTERED_NAME
	,RegistrationPEO.PLACE_OF_REGISTRATION
	,OrganizationUnitDPEOPsu.ORGANIZATION_ID       AS ORGANIZATION_ID1
	,OrganizationUnitDPEOPsu.EFFECTIVE_START_DATE  AS EFFECTIVE_START_DATE1
	,OrganizationUnitDPEOPsu.EFFECTIVE_END_DATE    AS EFFECTIVE_END_DATE1
	,OrganizationUnitDPEOPsu.OBJECT_VERSION_NUMBER AS OBJECT_VERSION_NUMBER3
	,RegistrationPEO.LOCATION_ID
	FROM XLE_ENTITY_PROFILES LegalEntityPEO
	,XLE_REGISTRATIONS RegistrationPEO
	,XLE_JURISDICTIONS_VL JurisdictionPEO
	,XLE_LOOKUPS XleLookupPEO
	,XLE_ENTITY_PROFILES LegalEntityPEOParentPsu
	,HZ_GEOGRAPHIES GeographyPEO
	,HR_ALL_ORGANIZATION_UNITS_F_VL OrganizationUnitDPEO
	,HR_ALL_ORGANIZATION_UNITS_F_VL OrganizationUnitDPEOPsu
	WHERE LegalEntityPEO.LEGAL_ENTITY_ID   = OrganizationUnitDPEO.LEGAL_ENTITY_ID
	AND LegalEntityPEO.LEGAL_EMPLOYER_FLAG = 'Y'
	AND LegalEntityPEO.PARENT_PSU_ID       = LegalEntityPEOParentPsu.LEGAL_ENTITY_ID (+)
	AND LegalEntityPEO.GEOGRAPHY_ID        = GeographyPEO.GEOGRAPHY_ID
	AND RegistrationPEO.SOURCE_TABLE       = 'XLE_ENTITY_PROFILES'
	AND LegalEntityPEO.LEGAL_ENTITY_ID     = RegistrationPEO.SOURCE_ID
	AND RegistrationPEO.IDENTIFYING_FLAG   = 'Y'
	AND RegistrationPEO.JURISDICTION_ID    = JurisdictionPEO.JURISDICTION_ID
	AND XleLookupPEO.LOOKUP_TYPE           = 'XLE_REG_CODE'
	AND XleLookupPEO.LOOKUP_CODE           = JurisdictionPEO.REGISTRATION_CODE_LE
	AND TRUNC(SYSDATE) BETWEEN OrganizationUnitDPEO.EFFECTIVE_START_DATE AND OrganizationUnitDPEO.EFFECTIVE_END_DATE
	and NVL(LEGALENTITYPEO.PARENT_PSU_ID,LEGALENTITYPEO.LEGAL_ENTITY_ID) = ORGANIZATIONUNITDPEOPSU.LEGAL_ENTITY_ID
	and TRUNC(sysdate) between ORGANIZATIONUNITDPEOPSU.EFFECTIVE_START_DATE and ORGANIZATIONUNITDPEOPSU.EFFECTIVE_END_DATE
	) LEGAL
,(SELECT LOCATION_NAME
	,LOCATION_ID
	FROM HR_LOCATIONS_ALL_F_VL
	WHERE SYSDATE BETWEEN EFFECTIVE_START_DATE AND EFFECTIVE_END_DATE
	) LocationDPEO
,(SELECT NAME
	,ORGANIZATION_ID
	FROM PER_DEPARTMENTS
	WHERE SYSDATE BETWEEN EFFECTIVE_START_DATE AND EFFECTIVE_END_DATE
	) DepartmentDPEO
,FUN_ALL_BUSINESS_UNITS_V BusinessUnitPEO
,(SELECT NAME
	,POSITION_ID
	FROM HR_ALL_POSITIONS_F_VL
	WHERE SYSDATE BETWEEN EFFECTIVE_START_DATE AND EFFECTIVE_END_DATE
	) PositionDPEO
,(SELECT NAME
	,JOB_ID
	FROM PER_JOBS_F_VL 
	WHERE SYSDATE BETWEEN EFFECTIVE_START_DATE AND EFFECTIVE_END_DATE
	) JobDPEO
,(SELECT NAME
	,GRADE_ID
	FROM PER_GRADES_F_VL
	WHERE SYSDATE BETWEEN EFFECTIVE_START_DATE AND EFFECTIVE_END_DATE
	) GRADEDPEO
,(SELECT PERSON_ID
	,MANAGER_ID
	,ASSIGNMENT_ID
	FROM PER_ASSIGNMENT_SUPERVISORS_F
	WHERE SYSDATE BETWEEN EFFECTIVE_START_DATE AND EFFECTIVE_END_DATE
	AND PRIMARY_FLAG = 'Y'
	) ASSIGN
where PERSONEO.PERSON_ID                          = PERSONNAMEDEO.PERSON_ID
and PERSONEO.PERSON_ID                            = PeriodOfServiceEO.PERSON_ID
and PERSONNAMEDEO.NAME_TYPE                      = 'GLOBAL'
and PERSONEO.PERSON_ID                            = EMAILADDRESSEO.PERSON_ID
and PERSONEO.PERSON_ID                            = PHONEEO.PERSON_ID(+)
and PHONEEO.phone_type(+) 									  = 'W1' 
and PERSONEO.PERSON_ID                            = FAXEO.PERSON_ID(+)
and FAXEO.PHONE_TYPE(+) 									  = 'WF' 
and PERSONEO.PERSON_ID                            = USERDETAILEO.PERSON_ID(+)
and PERSONEO.PERSON_ID                            = EMPLOYEEASSIGNMENTDEO.PERSON_ID
and EMPLOYEEASSIGNMENTDEO.PRIMARY_FLAG            = 'Y'
and PERSONEO.PERSON_ID                            = EMP_TYPE.PERSON_ID
and PERIODOFSERVICEEO.LEGAL_ENTITY_ID				  = LEGAL.ORGANIZATION_ID(+)	
AND((((EMPLOYEEASSIGNMENTDEO.ORGANIZATION_ID = DepartmentDPEO.ORGANIZATION_ID(+))
AND(EMPLOYEEASSIGNMENTDEO.BUSINESS_UNIT_ID   = BusinessUnitPEO.BU_ID(+)))
AND(EMPLOYEEASSIGNMENTDEO.POSITION_ID        = PositionDPEO.POSITION_ID(+)))
AND(EMPLOYEEASSIGNMENTDEO.JOB_ID             = JobDPEO.JOB_ID(+)))
AND(EMPLOYEEASSIGNMENTDEO.GRADE_ID           = GradeDPEO.GRADE_ID(+))
and EMPLOYEEASSIGNMENTDEO.LOCATION_ID        = LOCATIONDPEO.LOCATION_ID(+)
AND EMPLOYEEASSIGNMENTDEO.PERSON_ID = ASSIGN.PERSON_ID(+)
AND EMPLOYEEASSIGNMENTDEO.ASSIGNMENT_ID = ASSIGN.ASSIGNMENT_ID(+)
AND(sysdate BETWEEN PERSONNAMEDEO.EFFECTIVE_START_DATE AND PERSONNAMEDEO.EFFECTIVE_END_DATE)
AND(sysdate BETWEEN EMPLOYEEASSIGNMENTDEO.EFFECTIVE_START_DATE AND EMPLOYEEASSIGNMENTDEO.EFFECTIVE_END_DATE)
AND(sysdate BETWEEN EMP_TYPE.EFFECTIVE_START_DATE AND EMP_TYPE.EFFECTIVE_END_DATE)
and(EMPLOYEEASSIGNMENTDEO.EFFECTIVE_LATEST_CHANGE = 'Y')
AND EMPLOYEEASSIGNMENTDEO.ASSIGNMENT_STATUS_TYPE = 'ACTIVE'
AND EMP_TYPE.LEGAL_ENTITY_ID IS NULL
AND EMP_TYPE.SYSTEM_PERSON_TYPE IN ('EMP','APL','CWK','NONW')
Order by PERSONNAMEDEO.LAST_NAME
,PERSONNAMEDEO.FIRST_NAME